*************** CHROMIUM 2 Metacompiler for F83 ****************              (c) 1993,1995 Bradford J. Rodriguez                                                                               "I don't know why you people seem to think this is magic;        it's just this little chromium switch here."                        - The Firesign Theatre                                                                                                     based on Image Compiler for real-Forth, (c) 1988 B.J.Rodriguez    described in Forth Dimensions XIV:3, XIV:4, XIV:5             6809 assembler (c) 1985 B.J.Rodriguez                             described in The Computer Journal #52, #54                    6809 CamelForth (c) 1995 B.J.Rodriguez                            described in The Computer Journal, #59,60,62,64,67,69,72                                                                                                                                                                                                      ( Metacompiler & 6809 target LOAD SCREEN)       ( 12 feb 93 bjr)DECIMAL     2 LOAD   ( metacompiler vocabularies)               DECIMAL     3 LOAD   ( image to disk, big endian)               DECIMAL 24 26 THRU   ( DUMP & IBM PC Intel hex file output)     DECIMAL  4  7 THRU   ( target model - needed for assembler)     DECIMAL 30 44 THRU   ( 6809 assembler)                          DECIMAL  8 23 THRU   ( rest of metacompiler)                                                                                    ONLY FORTH META TARGET DEFINITIONS                              DECIMAL 61 119 THRU  ( 6809 source code)                        ONLY FORTH ALSO META                                            HEX E000 2000 HEXFILE 6809.HEX   ( make hex file, IBM PC only)  .MIRRORS                         ( print undef'd references )   BYE                                                                                                                                                                                             \   F83 extensions & metacompiler vocabularies   (c) 01apr95 bjrONLY FORTH DEFINITIONS     \ extensions to F83                  2 CONSTANT CELL            \ host computer's cell size          : OFFSET ( n - ) CREATE , DOES> @ + ;                           : AKA    ' CREATE , DOES> @ EXECUTE ;     \ AKA oldname newname : THRU   1+ SWAP DO  CR I .  .S I LOAD LOOP ;   \ lo hi THRU    ' : @ CONSTANT NEST                                    \ F83    : :NONAME ( - a)  HERE  NEST , ] ;                     \ F83    : ;NONAME  COMPILE UNNEST [COMPILE] [ ;  IMMEDIATE     \ F83    : COMPILE, ( xt)  , ;                                  \ F83                                                                    VOCABULARY META  ALSO META DEFINITIONS    \ metacompiler        VOCABULARY ASSEMBLER                      \ cross-assembler     VOCABULARY TARGET                         \ target words                                                                                                                                        \   Image to disk, big-endian, for 16-bit hosts  (c) 17apr95 bjr\   Target address unit = Host address unit; cell size=2        DECIMAL 176 CONSTANT BASE-SCREEN   ( last 64 screens)  HEX      : >< ( n - n)   0 100 UM/MOD  SWAP 100 * + ;                    : VIRTUAL ( a - a)   0 400 UM/MOD BASE-SCREEN + BLOCK + ;       : TC@ ( a - c)  VIRTUAL C@ ;                                    : TC! ( c a)    VIRTUAL C! UPDATE ;                             : T@  ( a - n)  DUP TC@ 100 * ( hi)  SWAP 1+ TC@ ( lo)  + ;     : T!  ( n a)   >R 0 100 UM/MOD  R@ TC! ( hi)  R> 1+ TC! ( lo) ; : >TCMOVE ( s d n) OVER + SWAP DO  DUP C@ I TC!  1+ LOOP DROP ;                                                                 : OOPS   DECIMAL BLK @ . >IN @ 40 /MOD . . ABORT ;              : TEXECUTE ( a)   U. ." Attempt to execute Target word " OOPS ; : >T  ( n)   ." Attempt to access Target stack " OOPS ;         : T>  ( - n )   >T ;                                                                                                            \   target memory size & alignment    6809 DTC   (c) 16apr95 bjr2 CONSTANT TCELL   \ target cell size in target address units   : TCELLS  2* ;                                                  : TCELL+  2+ ;                                                  1 CONSTANT TCHAR   \ target character size in target adrs units : TCHARS     ;                                                  : TCHAR+  1+ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \   Multiple target dictionaries, 16 bit         (c) 16apr95 bjr( 16 bit addresses)                                                                                                             VARIABLE 'TDP                                                   : DICTIONARY ( org limit)   CREATE SWAP , , DOES> 'TDP ! ;      : TDP   ( - a) 'TDP @ ;                                         : THERE ( - a) TDP @ ;                                          : ?FULL        TDP CELL + @                                         THERE U< ABORT" Dictionary overflowed!" ;                   : TALLOT ( n)  TDP +!  ?FULL ;                                  : T, ( n)      THERE T!  TCELL TALLOT ;                         : TC, ( n)     THERE TC! TCHAR TALLOT ;                         : ORG ( n)     TDP !  ?FULL ;                                                                                                                                                                                                                                   \   target threading model            6809 DTC   (c) 17apr95 bjr: TALIGNED ( a - a)  ;      \ align given target address        : TALIGN     ;              \ align target HERE                                                                                 HEX 0BD CONSTANT (JSR) \ 6809 JSR-extended opcode               : ,!VAL ( value tadr - n)  T!  2 ;             \ 16-bit value   : ,!REL ( value tadr - n)  TUCK 1+ - SWAP TC!  1 ;  \ 8-bit offs: ,!JSR ( value tadr - n)  (JSR) OVER TC!  1+ T!  3 ;  \ JSR    : ,!XT ( value tadr - n)   ,!VAL ;             \ Forth thread   : ,!CF ( value tadr - n)   ,!JSR ;             \ code field                                                                     : T!CF ( value tadr - )    ,!CF DROP ;                          : ,CODE ;              \ append code field for CODE word        : T>BODY   3 + ;   \ tcfa -- tpfa   address of parameter field                                                                                                                                  \   target header structure           CamelForth (c) 031mar15nacVARIABLE HEADS    -1 HEADS !     \ true = generate headers      VARIABLE TLATEST  0 TLATEST !    \ addr of latest target def'n                                                                  : (THEADER)               \ lay header except for code field        HEADS @ IF   >IN @                                                  TLATEST @ T,            \ target link                           THERE TLATEST !         \ update target link                    BL WORD THERE OVER C@   \ src(host), dst(target), len           WIDTH @ MIN 1+          \ F83 limit length, +1 for count        DUP TALLOT >TCMOVE      \ allot & copy to target            >IN !  THEN ;               \ no ALIGN needed               HEX                                                             : (TIMMEDIATE)            \ change latest header to immediate       HEADS @ IF  TLATEST @ DUP TC@ 40 OR SWAP TC!   THEN ;                                                                       \   Generic MIRROR word                          (c) 18apr95 bjr0 CELL * OFFSET TARG-VALUE    1 CELL * OFFSET HOST-COMP         2 CELL * OFFSET HOST-EXEC     3 CELL * OFFSET FWD-LIST          4 CELL * OFFSET MIRR-LINK     5 CELL * OFFSET PUT-CODE          6 CELL * OFFSET IMM-FLAG                                        VARIABLE TSTATE   0 TSTATE !   \ metacompile STATE              VARIABLE MLATEST  0 MLATEST !  \ mirror adrs of latest targ defnVARIABLE 'MIRROR  0 'MIRROR !  \ adrs of latest mirror defined  VARIABLE 'MA                   \ pfa of mirror word being exec'd: MA ( - a)   'MA @ ;          \ get address of mirror data                                                                     : MIRROR ( host-exec host-comp targ-val -- )                        CREATE  HERE >R  , , ,  0 ,  'MIRROR @ , R> 'MIRROR !              ['] ,!XT ,  0 ,         \ default "put" code                 DOES> DUP 'MA !  DUP IMM-FLAG @ TSTATE @ 0= OR                     IF HOST-EXEC ELSE HOST-COMP THEN @ EXECUTE ;             \   Forward referencing                          (c) 17apr95 bjr0 CELL * OFFSET REF-LINK      1 CELL * OFFSET REF-ADRS          : PUT-REF ( value tadr - n)  MA PUT-CODE @ EXECUTE ;            : !REF ( value tadr - )      PUT-REF DROP ;                     : ,REF ( value - )           THERE PUT-REF TALLOT ;             : +FWDREF ( - )           \ add target HERE to forward ref list     MA FWD-LIST DUP @        \ get adrs of list head  -- la head    HERE ROT !               \ this becomes new list head           , THERE ,                \ store link,targ-adrs in host         0 ,REF ;                 \ store empty cell in target       : (RESOLVE) ( value -- )   \ expects mirror adrs in 'MA             DUP MA TARG-VALUE !         \ store value in mirror word        MA FWD-LIST DUP @  0 ROT !  \ adrs of list element, zap head    BEGIN DUP WHILE             \ -- value el-adrs                      2DUP REF-ADRS @ !REF    \ patch cell in target image        REF-LINK @ REPEAT  2DROP ;                                  \   Host actions for mirror words                (c) 18apr95 bjr: .UNDEF        ." Error: no host action defined. " ABORT ;     : (PRESUME)     ['] .UNDEF ['] +FWDREF 0  MIRROR ;              : PRESUME       (PRESUME) 'MIRROR @ MLATEST ! ;  \ for EMULATES : IS-CF         ['] ,!CF  MLATEST @ PUT-CODE ! ;                : IS-JSR        ['] ,!JSR MLATEST @ PUT-CODE ! ;                : MIMMEDIATE    -1 MLATEST @ IMM-FLAG ! ;                       : EMULATES      ALSO META '  MLATEST @ HOST-EXEC !  PREVIOUS ;  : EMULATE:      ALSO META :NONAME  MLATEST @ HOST-EXEC ! ;      : ;EMULATE      [COMPILE] ;NONAME  PREVIOUS ;  IMMEDIATE        : M,REF ( - )   MA TARG-VALUE @ ,REF ;   \ usual compile action : DOCOMP ( - )  MA HOST-COMP @ EXECUTE ;                        : MCOMPILE, ( mcfa - )  >BODY 'MA ! DOCOMP ;                    : [TCOMPILE]    ' MCOMPILE, ;  \ force compile of following word: T' ( - tcfa)  ' >BODY TARG-VALUE @ ;                          : TPFA ( - tpfa)  MA TARG-VALUE @ T>BODY ;   \ get pfa of target\   Create/resolve mirror word                   (c) 18apr95 bjr: ?MIRROR  \ hexec hcomp tval --  build/resolve mirror word         >IN @ >R  DEFINED  IF >BODY   \ -- ma    if exists,                 DUP HOST-COMP @ ['] +FWDREF = IF   \ and it's fwd-ref,              DUP MLATEST !              \ save ma for DOES>                  'MA ! (RESOLVE)            \ resolve it                         MA HOST-COMP !  DROP       \ store compile action               R> DROP EXIT               \ we're done                 THEN THEN                     \ -- textadr   otherwise,         DROP R> >IN ! MIRROR            \ build the needed mirror       'MIRROR @ MLATEST ! ;           \ save ma for DOES>                                                                         : RESOLVES  \ value RESOLVES name   resolve a fwd ref               ' >BODY 'MA ! (RESOLVE)    \ get mirror word adrs, resolve      ['] M,REF MA HOST-COMP ! ; \ change compile action to append                                                                \   Meta CREATE                                  (c) 18apr95 bjrALSO TARGET DEFINITIONS  PRESUME DOCREATE IS-CF                 PREVIOUS DEFINITIONS                                                                                                            : M+HEADER                \ common factor of TCREATE etc.           (THEADER)                      \ compile header in target       ['] .UNDEF ['] M,REF THERE ?MIRROR ;  \ build mirror word                                                                   : TCREATE  M+HEADER                                                 [ TARGET ] ['] DOCREATE [ META ] MCOMPILE, ;                : ;C     [ ASSEMBLER ] EXITCODE [ META ]   PREVIOUS ;           : ASM:   [ ASSEMBLER ] ENTERCODE [ META ]  ALSO ASSEMBLER ;     : CODE   M+HEADER  ,CODE  ASM: ;  \ build CODE word's code fld                                                                                                                                                                                                  \   Literals, equates, duals                     (c) 17apr95 bjrALSO TARGET DEFINITIONS  PRESUME LIT  PREVIOUS DEFINITIONS      : TLITERAL ( n - )                                                  [ TARGET ] ['] LIT [ META ] MCOMPILE,  T, ;                 : T['] ( - )   T' TLITERAL ;                                    : M['] ( - )   T' [COMPILE] LITERAL ; IMMEDIATE  \ lit in host!                                                                 : @EQU ( - n )   MA TARG-VALUE @ ;       \ fetch TARG-VALUE     : ,EQU ( - )    @EQU TLITERAL ;                                 : EQU  ( n - )   ['] @EQU ['] ,EQU ROT MIRROR ;                                                                                 VARIABLE DUAL   0 DUAL !            \ true=generate host "dual" : DUAL?   DUAL @ TSTATE @ AND ;     \ true if dual & compiling  TARGET ' DOCREATE META @ CONSTANT MIRROR-CF              \ F83  : DUAL, ( xt -- )  DUP @ MIRROR-CF =                     \ F83      IF >BODY HOST-EXEC @ THEN  ( xt) COMPILE, ;          \ F83  \   Meta compiler engine                    F83  (c) 18apr95 bjr: T[   0 TSTATE !  ;                                            : T]  -1 TSTATE !                                                  BEGIN  ?STACK  >IN @  DEFINED    \ F83                             IF  ( found)  NIP DUAL? IF DUP DUAL, THEN                                         EXECUTE                                       ELSE NUMBER?                                                       IF  ( number) DROP DUAL? IF DUP [COMPILE] LITERAL THEN                         TLITERAL  DROP                                   ELSE ( undef)  DUAL? IF .UNDEF THEN                                            2DROP  >IN ! (PRESUME)  \ build fwd ref                         'MIRROR @ 'MA ! +FWDREF                       THEN THEN                                                    TSTATE @ 0=  END? @ OR  UNTIL  END? OFF ;   \ F83                                                                                                                                            \ Target interpretation                         ( 01 f31mar15nac: D>T ( d)   DPL @ 1+ IF SWAP >T ELSE DROP THEN  >T ;                                                                           : TINTERPRET   BEGIN ?STACK DEFINED                                   IF ( found)  EXECUTE                                            ELSE ( number?)  NUMBER D>T  THEN                            FALSE DONE? UNTIL ;                                                                                                          : TQUIT   BLK OFF STATE OFF                                        BEGIN  RP0 @ RP!  CR QUERY TINTERPRET ." Tok"  AGAIN ;                                                                       : HOT    CR ."  Tok" QUIT ;                                     : COOL   CR ."  ok"  QUIT ;                                                                                                                                                                                                                                     \   Target colon definition                      (c) 17apr95 bjrALSO TARGET DEFINITIONS  PRESUME DOCOLON IS-CF                                           PRESUME EXIT     PREVIOUS DEFINITIONS                                                                  : T:   M+HEADER                       \ targ.header & mirror        [ TARGET ] ['] DOCOLON [ META ] MCOMPILE,   \ build colondef    DUAL? IF                                                            HERE NEST ,                    \ F83                            'MIRROR @ HOST-EXEC !          \ start dual definition      THEN T] ;                                                                                                                   : T;   [ TARGET ] ['] EXIT [ META ] MCOMPILE,   \ compile EXIT      DUAL? IF  COMPILE UNNEST  THEN              \ F83               T[ ;                                                                                                                        : TIMMEDIATE    (TIMMEDIATE) MIMMEDIATE ;                       \   Meta DOES>                              F83  (c) 19apr95 bjrALSO TARGET DEFINITIONS  PRESUME DODOES IS-JSR                                           PRESUME (DOES>)  PREVIOUS DEFINITIONS  VARIABLE TARG-DOES       \ to remember adrs of target DOES code : (MDOES>)  ( adrs.targ.code -- )       \ *** not valid ANSI ***    MLATEST @ TARG-VALUE @ ( tcfa) T!CF  \ change tgt code field    R> MLATEST @ HOST-EXEC ! ;     \ host-exec -> following code: MDOES>   TARG-DOES @ [COMPILE] LITERAL \ compile tgt DOES adr     COMPILE (MDOES>)                     \ compile host (MDOES>)    NEST ,  COMPILE TPFA ; IMMEDIATE     \ begin host's DOES def                                                                : T;CODE   [ TARGET ] ['] (DOES>) [ META ] MCOMPILE,                THERE TARG-DOES !   T[ ALSO ASSEMBLER ;                     : TDOES>   [ TARGET ] ['] (DOES>) [ META ] MCOMPILE,                THERE TARG-DOES !   [ TARGET ] DODOES [ META ]                  DUAL? IF [COMPILE] MDOES> THEN  ;                           \   Initial target vocabulary: directives        (c) 18apr95 bjrALSO TARGET DEFINITIONS  META                                   AKA META META    AKA TARGET TARGET    AKA ASSEMBLER ASSEMBLER   AKA LOAD LOAD    AKA \ \              AKA \S \S                 AKA CODE CODE    AKA EQU EQU          AKA ;C ;C                 AKA T;CODE ;CODE     AKA BYE BYE                                AKA RESOLVES RESOLVES   AKA ORG ORG   AKA THRU THRU             AKA [TCOMPILE] [COMPILE]   AKA ( (    AKA ASM: ASM:             AKA EMULATES EMULATES      AKA EMULATE: EMULATE:                AKA ;EMULATE ;EMULATE IMMEDIATE   AKA DICTIONARY DICTIONARY     AKA PRESUME PRESUME        AKA IS-CF IS-CF   AKA AKA AKA                                                                        : +DUAL  DUAL ON ;    : -DUAL  DUAL OFF ;                       : +HEADS HEADS ON ;   : -HEADS HEADS OFF ;                      META                                                                                                                            \   Initial target vocabulary: synonyms          (c) 17apr95 bjrPRESUME :         EMULATES T:                                   PRESUME ;         EMULATES T;          MIMMEDIATE               PRESUME IMMEDIATE EMULATES TIMMEDIATE                           PRESUME DOES>     EMULATES TDOES>      MIMMEDIATE               PRESUME [         EMULATES T[          MIMMEDIATE               PRESUME ]         EMULATES T]                                   PRESUME @         EMULATES T@                                   PRESUME !         EMULATES T!                                   PRESUME C@        EMULATES TC@                                  PRESUME C!        EMULATES TC!                                  PRESUME ,         EMULATES T,                                   PRESUME C,        EMULATES TC,                                  PRESUME HERE      EMULATES THERE                                PRESUME ALLOT     EMULATES TALLOT                               PRESUME CREATE    EMULATES TCREATE                              \   Initial target vocabulary: synonyms          (c) 1          PRESUME '         EMULATES T'                                   PRESUME [']       EMULATES T[']       MIMMEDIATE                PRESUME CELL      EMULATES TCELL                                PRESUME CELLS     EMULATES TCELLS                               PRESUME CELL+     EMULATES TCELL+                               PRESUME CHARS     EMULATES TCHARS                               PRESUME CHAR+     EMULATES TCHAR+                               PRESUME ALIGN     EMULATES TALIGN                               PRESUME ALIGNED   EMULATES TALIGNED                             PRESUME HEX       EMULATES HEX                                  PRESUME DECIMAL   EMULATES DECIMAL                              PRESUME (         EMULATES (        MIMMEDIATE                  PRESUME \         EMULATES \        MIMMEDIATE                  PREVIOUS DEFINITIONS                                                                                                            \ Support for CamelForth DO loops                (c) 25apr95 bjrORDER                                                           CREATE LOOPSTACK  20 CELL * ALLOT                               VARIABLE TLP      LOOPSTACK TLP !       \ target loop stack ptr                                                                 : T>L  CELL TLP +!  TLP @ ! ;         \ x --   put on loop stack: TL>  TLP @ @   CELL NEGATE TLP +! ; \ -- x   get from loop stk                                                                \ Forth words which need to be in META vocabulary               AKA DUP DUP  AKA SWAP SWAP                                      : .S CR .S ;                                                                                                                    \ Forth words which need to be in META ASSEMBLER                ALSO ASSEMBLER DEFINITIONS                                      AKA + +                                                         PREVIOUS DEFINITIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Show mirror words                              (c) 18apr95 bjrVARIABLE EVERYONE  0 EVERYONE !  DECIMAL                        : TAB ( n)   #OUT @ - 1 MAX SPACES ;                            : .MIRRORS   'MIRROR @                                             BEGIN DUP WHILE  ( - ma )                                        DUP FWD-LIST @  EVERYONE @ OR  IF                                 DUP           BODY> >NAME CR .ID ." :"                          DUP           @  12 TAB ." value=" 5 U.R                        DUP FWD-LIST  @  24 TAB ." fwdlist=" 5 U.r                      DUP PUT-CODE  @  36 TAB ." put="   >NAME .ID                    DUP HOST-COMP @  49 TAB ." comp="  >NAME .ID                    DUP HOST-EXEC @  62 TAB ." exec="  >NAME .ID                    KEY? IF KEY DROP KEY 27 = IF DROP EXIT THEN THEN              THEN                                                           MIRR-LINK @ REPEAT DROP ;                                                                                                    ( Image dump)   HEX                             ( 31 jan 93 bjr): (DUMP)  \ addr ct ---  | dump as pointed to by reloc            SPACE  OVER + SWAP DO  I TC@ 3 .R  LOOP ;                                                                                     : LASCI   \ addr ct ---  | asci type as pointed to by reloc       SPACE  OVER + SWAP DO  I TC@  7F AND  DUP                         20 7F WITHIN 0= IF DROP 2E ( .) THEN  EMIT  LOOP ;                                                                          : HEAD  \ addr --- | header for dump display                      10 0 DO I OVER + 0F AND 3 .R LOOP DROP ;                                                                                        \ N. B: Not responsible for negative counts! -- the MGT.      : DUMP   \  addr ct ---  | dump as pointed to by reloc            OVER CR 6 SPACES HEAD  BEGIN  DUP  WHILE  CR OVER 5 U.R            2DUP 10 MIN >R  R@ 2DUP (DUMP)  36 #OUT @ - SPACES LASCI        R@ R> NEGATE D+  KEY? IF DROP 0 THEN  REPEAT 2DROP ;       ( Intel hex files, F83 on IBM PC)   HEX         ( 07 feb 93 bjr)FORTH DEFINITIONS                                               CODE >< ( n - n)   AX POP  AH AL XCHG  1PUSH  END-CODE                                                                          CODE INT21   AX POP  BX POP  CX POP  DX POP  HEX 21 INT            AX RCL  AX ROR  1PUSH  END-CODE                              : CLSF ( h - err)   0 0 ROT 3E00 INT21 ;                        : WTF  ( a n h - err)   4000 INT21 ;                            : MAKF ( a - h)   0 0 3C00 INT21 ;                                                                                              META DEFINITIONS                                                VARIABLE IHANDLE   IHANDLE OFF                                                                                                  CREATE HEXTBL  30 C, 31 C, 32 C, 33 C, 34 C, 35 C, 36 C, 37 C,                 38 C, 39 C, 41 C, 42 C, 43 C, 44 C, 45 C, 46 C,                                                                     ( Intel hex files, F83)  HEX                 ( 07 feb 93 bjr): ,H  ( n - c)  HEXTBL + C@ C, ;                                : ,HH ( u c - u)  DUP  DUP 0F0 AND 10 / ,H  0F AND ,H  + ;                                                                      : WREC ( type a n)   HERE >R  SWAP >R                              3A C,  0 OVER ,HH   R@ >< ,HH  R@ ,HH  ROT ,HH  R> ROT          ?DUP IF  OVER + SWAP DO  I TC@ ,HH  LOOP                           ELSE  DROP  THEN                                             NEGATE DUP ,HH DROP   0D C, 0A C,                               R> HERE OVER DP ! OVER -  IHANDLE @ WTF 0< ABORT" Write err"    ;                                                            : HEXFILE ( a n)   BL WORD COUNT OVER + OFF                        MAKF DUP 0< ABORT" Open err"  IHANDLE !                         OVER + SWAP DO  0 I 10 WREC  10 +LOOP                           1 0 0 WREC  IHANDLE @ CLSF  DROP ;        DECIMAL                                                                            ( Image to disk, little-endian, 16-bit hosts)   ( 31 jan 93 bjr)                                                                DECIMAL 176 CONSTANT BASE-SCREEN   ( last 64 screens)           HEX                                                             : >< ( n - n)   0 100 UM/MOD  SWAP 100 * + ;                    : VIRTUAL ( a - a)   0 400 UM/MOD BASE-SCREEN + BLOCK + ;       : TC@ ( a - b)  VIRTUAL C@ ;                                    : TC! ( b a)    VIRTUAL C! UPDATE ;                             : T@  ( a - n)  DUP TC@ ( lo)  SWAP 1+ TC@ 100 * ( hi)  + ;     : T!  ( n a)   >R 0 100 UM/MOD  R@ 1+ TC! ( hi)  R> TC! ( lo) ; : >TCMOVE ( s d n) OVER + SWAP DO  DUP C@ I TC!  1+ LOOP DROP ; : INVOKE  ( a)   U. 1 ABORT" Attempt to execute Target word!" ;                                                                                                                                                                                                                                                                 ( Image to target machine, big-endian, 16 bit)  ( 31 jan 93 bjr)                                                                HEX                                                             : >< ( n - n)   0 100 UM/MOD  SWAP 100 * + ;                    : TC@ ( a - b)   XADR X@+ ;                                     : TC! ( b a)     XADR X!+ ;                                     : T@  ( a - n)   XADR X@+ 100 * ( hi)  X@+ ( lo) + ;            : T!  ( n a)     XADR DUP 0 100 UM/MOD  X!+ ( hi) X!+ ( lo) ;   : >TCMOVE ( s d n)  SWAP XADR  OVER + SWAP DO  I C@ X!+  LOOP ; : INVOKE ( cfa)   GO AWAIT ;                                                                                                                                                                                                                                                                                                                                                                                                                                    ( Image to target, little-endian, 16 bit)       ( 31 jan 93 bjr)                                                                HEX                                                             : >< ( n - n)   0 100 UM/MOD  SWAP 100 * + ;                    : TC@ ( a - b)   XADR X@+ ;                                     : TC! ( b a)     XADR X!+ ;                                     : T@  ( a - n)   XADR X@+ ( lo)  X@+ 100 * ( hi) + ;            : T!  ( n a)     XADR DUP 0 100 UM/MOD  SWAP X!+ X!+ ( lo,hi) ; : >TCMOVE ( s d n)  SWAP XADR  OVER + SWAP DO  I C@ X!+  LOOP ; : INVOKE ( cfa)   GO AWAIT ;                                                                                                                                                                                                                                                                                                                                                                                                                                    \   6809 assembler: utilities                         01apr15nacALSO META ASSEMBLER DEFINITIONS  ORDER  HEX                                                                                     : WITHIN   ROT SWAP OVER   \ n lo hi -- f | test within limits     < ROT ROT > OR 0= ;                                          : 8BIT?   -80 7F WITHIN ;                                       : 5BIT?   -10 0F WITHIN ;                                                                                                       \ : ALIGN ;  ( for 8-bit versions)                              : N,       , ;                                                  : NCREATE  CREATE ;                                                                                                                                                                                                                                                                                                                                                                             \   6809 assembler: addressing modes            ( 01 feb 93 bjr): OPCODE,                  \ store opcode with prefix (if any)     DUP 0FF00 AND  IF T, ELSE TC, THEN  ;                                                                                        VARIABLE MODE   \ 0=immed, 10=direct, 20=indexed, 30=extended   : #   0 MODE ! ;    : <>   10 MODE ! ;                                                                                          : ?ADRERR   IF ." Illegal addressing mode " DECIMAL BLK @ .                 >IN @ 40 /MOD . .  ABORT THEN ;                     : INDEXREG   20 MODE !   \ rval postbyte -- postbyte |             SWAP  1-  DUP 0 3 WITHIN 0= ?ADRERR   \ must be x,y,u, or s     20 * OR ;                             \ put reg # in postbyte: XMODE   NCREATE N,    \ postbyte --  | Simple Indexed Modes      DOES>  @ INDEXREG ;  \ rval -- postbyte                      84 XMODE 0,    86 XMODE A,    85 XMODE B,    8B XMODE D,        80 XMODE ,+    81 XMODE ,++   82 XMODE -,    83 XMODE --,       \   6809 assembler: addressing modes            ( 01 feb 93 bjr): ,      SWAP 89 INDEXREG ;   \ rval n -- n postbyte |          : ,PCR   20 MODE !  8D ;      \ n -- n postbyte |                                                                               : []   MODE @ 20 =    \ Indexed:  postbyte -- postbyte                                \ Extended:        n -- n postbyte           IF  DUP 9D AND 80 = ?ADRERR   10 +    \ Indexed Indirect        ELSE  20 MODE !  9F THEN ;            \ Extended Indirect                                                                    : RESET   30 MODE ! ;      RESET                                                                                                \ register definitions                                          0 CONSTANT D    1 CONSTANT X    2 CONSTANT Y    3 CONSTANT U    4 CONSTANT S    5 CONSTANT PC   8 CONSTANT A    9 CONSTANT B    0A CONSTANT CCR    0B CONSTANT DPR                                                                                              \   6809 assembler: inherent instructions       ( 01 feb 93 bjr): INHOP   NCREATE  N,      \ opcode -- | Inherent Addressing       DOES>   @ OPCODE, RESET ; \ -- | lay one or two bytes                                                                        3A INHOP ABX,   48 INHOP ASLA,  58 INHOP ASLB,  47 INHOP ASRA,  57 INHOP ASRB,  4F INHOP CLRA,  5F INHOP CLRB,  43 INHOP COMA,  53 INHOP COMB,  19 INHOP DAA,   4A INHOP DECA,  5A INHOP DECB,  4C INHOP INCA,  5C INHOP INCB,  48 INHOP LSLA,  58 INHOP LSLB,  44 INHOP LSRA,  54 INHOP LSRB,  3D INHOP MUL,   40 INHOP NEGA,  50 INHOP NEGB,  12 INHOP NOP,   49 INHOP ROLA,  59 INHOP ROLB,  46 INHOP RORA,  56 INHOP RORB,  3B INHOP RTI,   39 INHOP RTS,   1D INHOP SEX,   3F INHOP SWI, 103F INHOP SWI2, 113F INHOP SWI3, 13 INHOP SYNC,  4D INHOP TSTA,  5D INHOP TSTB,                                                                                                                                                                                                                  \   6809 assembler: immediate instructions      ( 01 feb 93 bjr): IMMOP   NCREATE  N,      \ opcode -- | Immediate Only (8-bit)    DOES>   MODE @ ?ADRERR   @ TC, TC, RESET ;  \ operand --                                                                     3C IMMOP CWAI,  34 IMMOP PSHS,  36 IMMOP PSHU,  35 IMMOP PULS,  37 IMMOP PULU,  1C IMMOP ANDCC, 1A IMMOP ORCC,                                                                                  : RROP   NCREATE  N,       \ opcode -- | Register-Register         DOES>   @ TC,  SWAP 10 * + TC, RESET ;  \ srcrval dstrval --                                                                 1E RROP EXG,    1F RROP TFR,                                                                                                                                                                                                                                                                                                                                                                    \   6809 assembler: +mode                       ( 01 feb 93 bjr): +MODE    \ operand -- operand | modify operand per mode          MODE @ +  DUP 0F0 AND 50 = IF 0F AND THEN ; \ change 5x to 0x                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \   6809 assembler: pcrel, cofset                     01apr15nac: PCREL   \ operand postbyte -- | lay PC relative                  SWAP  THERE 2 + -  DUP 8BIT?  \ try 8 bit relative offset       IF  SWAP 0FE AND TC, TC,      \ it fits...lay postbyte,offset   ELSE  1-  SWAP TC, T,  THEN ; \ no good...use 16 bit relative                                                                : NOTINDIR?  10 AND 0= ;  \ postbyte -- f | test for indirection                                                                : COFSET   \ operand postbyte -- | lay constant offset             OVER 0= IF  0F0 AND 4 OR TC, DROP     \ no offset               ELSE OVER 5BIT? OVER NOTINDIR? AND IF                              60 AND SWAP 1F AND OR TC,          \ 5 bit offset            ELSE OVER 8BIT? IF  0FE AND TC, TC,   \ 8 bit offset            ELSE  TC, T,  THEN THEN THEN ;        \ 16 bit offset                                                                                                                                        \   6809 assembler: indexed, immed                    01apr15nac: EXTIND    \ operand postbyte -- | lay extended indirect          TC, T, ;      \ lay postbyte and operand                                                                                     : INDEXED   \ operand? postbyte -- | lay indexed poststuff         DUP 8F AND           \ check postbyte for modes w/ operands        DUP 89 = IF DROP  COFSET  ELSE      \ const.offset              DUP 8D = IF DROP  PCREL   ELSE      \ PC relative               DUP 8F = IF DROP  EXTIND  ELSE      \ extended indir                        DROP  TC,  \ "simple" modes, postbyte only       THEN THEN THEN ;                                                                                                             : IMMED   \ operand opcode-pfa -- | lay immediate poststuff        2 + @  DUP 0= ?ADRERR    \ test immedsize                       1- IF T, ELSE TC, THEN ; \ lay immediate operand in reqd.size                                                                \   6809 assembler: general addr instr          ( 01 feb 93 bjr): GENOP   NCREATE  N, N,   \ immedsize opcode -- | Gen'l Addr      DOES>   DUP @ +MODE OPCODE,   \ [see below] | lay opcode           MODE @ DUP  0 = IF DROP  IMMED         ELSE   \ immediate              DUP 10 = IF DROP  DROP TC,      ELSE   \ direct                 DUP 20 = IF DROP  DROP INDEXED  ELSE   \ indexed                DUP 30 = IF DROP  DROP T,       ELSE   \ extended                           DROP                                         THEN THEN THEN THEN  RESET ;                                                                                              : INXOP   NCREATE  N,       \ opcode -- | Indexed Only             DOES>   MODE @ 20 - ?ADRERR   @ OPCODE, INDEXED RESET ;      \ Stack action of general addressing instructions               \ (1) immediate, direct, extended:                 operand --   \ (2) all indexed except (3):                     postbyte --   \ (3) const.offset, PCR, extended indir:  operand postbyte --   \   6809 assembler: general addr instr          ( 01 feb 93 bjr)1   89 GENOP ADCA,   1  0C9 GENOP ADCB,   1   8B GENOP ADDA,    1  0CB GENOP ADDB,   2  0C3 GENOP ADDD,   1   84 GENOP ANDA,    1  0C4 GENOP ANDB,   1   85 GENOP BITA,   1  0C5 GENOP BITB,    0   48 GENOP ASL,    0   47 GENOP ASR,    0   4F GENOP CLR,     1   81 GENOP CMPA,   1  0C1 GENOP CMPB,   2 1083 GENOP CMPD,    2 118C GENOP CMPS,   2 1183 GENOP CMPU,   2   8C GENOP CMPX,    2 108C GENOP CMPY,   1   88 GENOP EORA,   1  0C8 GENOP EORB,    0   43 GENOP COM,    0   4A GENOP DEC,    0   4C GENOP INC,     1   86 GENOP LDA,    1  0C6 GENOP LDB,    2  0CC GENOP LDD,     2 10CE GENOP LDS,    2  0CE GENOP LDU,    2   8E GENOP LDX,     2 108E GENOP LDY,    0   4E GENOP JMP,    0   8D GENOP JSR,     0   48 GENOP LSL,    0   44 GENOP LSR,    0   40 GENOP NEG,     1   8A GENOP ORA,    1  0CA GENOP ORB,    0   49 GENOP ROL,                                                                                                                                     \   6809 assembler: general addr instr          ( 01 feb 93 bjr)0   46 GENOP ROR,    1   82 GENOP SBCA,   1  0C2 GENOP SBCB,    0   87 GENOP STA,    0  0C7 GENOP STB,    0  0CD GENOP STD,     0 10CF GENOP STS,    0  0CF GENOP STU,    0   8F GENOP STX,     0 108F GENOP STY,    1   80 GENOP SUBA,   1  0C0 GENOP SUBB,    2   83 GENOP SUBD,   0   4D GENOP TST,                                                                                          32 INXOP LEAS,  33 INXOP LEAU,  30 INXOP LEAX,  31 INXOP LEAY,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  \   6809 assembler: branches                          01apr15nac: CONDBR   NCREATE  N,      \ opcode -- | Conditional Branch       DOES>   @  SWAP THERE 2 + -     \ addr --                       DUP 8BIT? IF  SWAP TC, TC,                   \ 8 bit            ELSE  10 TC, SWAP TC, 2 - T,  THEN RESET ;   \ 16 bit                                                                        : UNCBR   NCREATE  N,       \ short:long -- | Unconditional Br.    DOES>   @  SWAP THERE 2 + -         \ addr --                   DUP 8BIT? IF  SWAP >< TC, TC,       \ 8 bit: use short opcode   ELSE  SWAP TC, 1- T,  THEN RESET ;  \ 16 bit: use long opcode                                                                                                                                                                                                                                                                                                                                                                                                \   6809 assembler: branch instructions         ( 01 feb 93 bjr)24 CONDBR BCC,  25 CONDBR BCS,  27 CONDBR BEQ,  2C CONDBR BGE,  2E CONDBR BGT,  22 CONDBR BHI,  24 CONDBR BHS,  2F CONDBR BLE,  25 CONDBR BLO,  23 CONDBR BLS,  2D CONDBR BLT,  2B CONDBR BMI,  26 CONDBR BNE,  2A CONDBR BPL,  21 CONDBR BRN,  28 CONDBR BVC,  29 CONDBR BVS,  2016 UNCBR BRA,  8D17 UNCBR BSR,                                                                                \   6809 assembler: conditions                  ( 01 feb 93 bjr)24 CONSTANT CS  25 CONSTANT CC  27 CONSTANT NE  2C CONSTANT LT  2E CONSTANT LE  22 CONSTANT LS  24 CONSTANT LO  2F CONSTANT GT  25 CONSTANT HS  23 CONSTANT HI  2D CONSTANT GE  2B CONSTANT PL  26 CONSTANT EQ  2A CONSTANT MI  21 CONSTANT ALW 28 CONSTANT VS  29 CONSTANT VC  20 CONSTANT NVR                                                                                                                                                                                                                                 \   6809 assembler: structured conditionals      (c) 17apr95 bjr: IF,     \ br.opcode -- adr.next.instr  | reserve space           TC, 0 TC, THERE ;                                            : ENDIF,  \ adr.instr.after.br -- | patch the forward ref.         THERE OVER -  DUP 8BIT? 0= ?ADRERR  SWAP 1- TC! ;            : ELSE,   \ adr.after.br -- adr.after.this.br                      NVR IF,  SWAP ENDIF, ;                                       : BEGIN,  \ -- dest.adr                                            THERE ;                                                      : UNTIL,  \ dest.adr br.opcode --                                  TC,  THERE 1+ -  DUP 8BIT? 0= ?ADRERR  TC, ;                 : WHILE,  \ dest.adr br.opcode -- adr.after.this dest.adr          IF, SWAP ;                                                   : REPEAT, \ adr.after.while dest.adr.of.begin --                   NVR UNTIL,  ENDIF, ;                                         : THEN,  ENDIF, ;   : END,  UNTIL, ;                            \   6809 assembler: next, code  6809 DTC model   (c) 01apr95 bjr: ENTERCODE   RESET ;        \ used by metacompiler             : EXITCODE    ;              \ used by metacompiler                                                                             : NEXT,  Y ,++ [] JMP, ;     \ 6809 DTC                         AKA NEXT, NEXT                                                  Y CONSTANT IP   S CONSTANT SP   U CONSTANT RP   X CONSTANT W                                                                    PREVIOUS DEFINITIONS  ORDER  \ end of assembler!                                                                                \ : CODE        THEAD ENTERCODE ;   ...defined in metacompiler  \ : ;C          ;              \ aka END-CODE on some systems                                                                                                                                                                                                                                                                   \ Load screen for Multicomp port                      29apr15nacDECIMAL     2 LOAD ( METACOMPILER VOCABS)                       DECIMAL     3 LOAD ( IMAGE TO DISK, BIG-ENDIAN)                 DECIMAL 24 26 THRU ( DUMP AND IBM PC IMAGE SAVE)                DECIMAL  4  7 THRU ( TARGET MODEL - NEEDED FOR ASSEMBLER)       DECIMAL 30 44 THRU ( 6809 ASSEMBLER)                            DECIMAL  8 23 THRU ( REST OF METACOMPILER)                                                                                      ONLY FORTH META TARGET DEFINITIONS                              DECIMAL 46 48   THRU ( MULTICOMP VERSIONS OF 61-63)             DECIMAL 64 117  THRU ( 6809 SOURCE CODE)                        DECIMAL 51 57   THRU ( MULTICOMP EXTRAS)                        DECIMAL 49 50   THRU ( MULTICOMP VERSIONS OF 118-119)           ONLY FORTH ALSO META                                            HEX E000 2000 HEXFILE 6809M.HEX                                 .MIRRORS BYE                                                    \ like scr61 but for multicomp                        14apr15nacHEX E000 FFFF DICTIONARY ROM  ROM                                  0600 EQU UP-INIT      \ UP must be page aligned.  Stacks,       06   EQU UP-INIT-HI   \   TIB, etc. init'd relative to UP.                                                                      0000 EQU DP-INIT      \ starting RAM adrs for dictionary        \ Multicomp map: 8K ROM from E000, RAM from 0, I/O FFD0-FFDF    \ .. UP-INIT sized for 2k RAM!! UP-INIT is RAMTOP-0200       \ Harvard synonyms - these must all be PRESUMEd                 AKA , I,     AKA @ I@     AKA ! I!                              AKA C, IC,   AKA C@ IC@   AKA C! IC!                            AKA HERE IHERE     AKA ALLOT IALLOT                             PRESUME WORD       AKA WORD IWORD                                                                                                                                                                                                                               \ like scr62 but for multicomp                        01apr15nac                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ like scr63 but for multicomp                        01apr15nacHEX FFD0 EQU VDUCMD   FFD1 EQU VDUDAT                                                                                           CODE KEY    \ -- c    get char from serial port                    6 # ( D) PSHS,   BEGIN,   VDUCMD LDB,   1 # ANDB,  NE UNTIL,    VDUDAT LDB,   CLRA,   NEXT ;C                                                                                                CODE KEY?   \ -- f    return true if char waiting                  6 # ( D) PSHS,   CLRA,   VDUCMD LDB,   1 # ANDB,                NE IF,   -1 # LDB,   THEN,   NEXT ;C                                                                                         CODE EMIT   \ c --    output character to serial port              BEGIN,   VDUCMD LDA,   2 # ANDA,   NE UNTIL,                    VDUDAT STB,   6 # ( D) PULS,   NEXT ;C                                                                                                                                                       \ like scr 118 but for multicomp                      01apr15nacASM: HERE EQU ENTRY   HEX                                                                                                                                                                                                                                          UP-INIT-HI # LDA,   A DPR TFR,   \ initial UP                   UP-INIT 100 + # LDS,             \ initial SP                   UP-INIT 200 + # LDU,             \ initial RP                                                                                                                                                   ' COLD JMP,   ;C           \ enter top-level Forth word      ASM: HERE EQU IRET   RTI,  ;C                                   HERE  0FFF0 ORG    \ 6809 hardware vectors                        IRET ,  IRET ,  IRET ,  IRET ,    \ tbd, SWI3, SWI2, FIRQ       IRET ,  IRET ,  IRET ,  ENTRY ,   \ IRQ, SWI, NMI, RESET      ORG                                                             \ like scr 119 but for multicomp                 (c) 230nar15nacDECIMAL 18 CONSTANT #INIT   \ # bytes of user area init data                                                                    CREATE UINIT  HEX                                                  0 , 0 , 0A , 0 ,         \ reserved,>IN,BASE,STATE              DP-INIT ,                \ DP                                   0 , 0 ,                  \ SOURCE init'd elsewhere           META ALSO FORTH TLATEST @ T, PREVIOUS TARGET    \ LATEST           0 ,                      \ HP init'd elsewhere               \ Note that UINIT must be the *last* word in the kernel, in     \ order to set the initial LATEST as shown above.  If this is   \ not the last word, be sure to patch the LATEST value above.                                                                                                                                                                                                                                                                   \ Multicomp extras: SDCARD access                     29aug15nacHEX                                                             : SDLBA2  ( n -- ) FFDC C! ;                                    : SDLBA10 ( n -- ) DUP FF AND FFDA C! 8 RSHIFT FFDB C! ;                                                                        : SDIDLE FFD9 BEGIN DUP C@ 80 = UNTIL DROP ;                                                                                    : SDRD ( block c-addr-dest -- ) \ read 512 bytes                  SWAP SDLBA10 SDIDLE 0 FFD9 C! ( read)  DUP 200 + SWAP DO          FFD9 BEGIN DUP C@ E0 = UNTIL DROP ( byte available)             FFD8 C@ I C! LOOP ;                                                                                                         : SDWR ( block c-addr-src -- ) \ write 512 bytes                  SWAP SDLBA10 SDIDLE 1 FFD9 C! ( write) DUP 200 + SWAP DO          FFD9 BEGIN DUP C@ A0 = UNTIL DROP ( space available)            I C@ FFD8 C! LOOP ;                                         \ Multicomp extras: helpers for bootloaders           29aug15nac: SDRDn ( block c-addr-dest #blocks --)                           0 DO 2DUP SDRD 200 + SWAP 1+ SWAP                                 LOOP 2DROP ;                                                                                                                : SDRD256 ( block c-addr-dest -- ) \ first 256bytes of block      SWAP SDLBA10 SDIDLE 0 FFD9 C! ( read)  DUP 100 + SWAP DO          FFD9 BEGIN DUP C@ E0 = UNTIL DROP ( byte available)             FFD8 C@ I C! LOOP                                             100 0 DO ( 256 bytes)                                             FFD9 BEGIN DUP C@ E0 = UNTIL DROP ( byte available)             FFD8 C@ DROP LOOP ;                                                                                                         : SDRD256n ( block c-addr-dest #blocks --)                        0 DO 2DUP SDRD256 100 + SWAP 1+ SWAP                              LOOP 2DROP ;                                                \ Multicomp extras: helpers for bootloaders           22jun15nac: piv ( --) \ helper for PIVOT, PIVOTRST                          4F   1000 C!                     ( CLRA)                        1F8B 1001 !                      ( TFR A,DP)                    86A0 1003 !                      ( LDA #A0)                     B7   1005 C! FFDE 1006 !         ( STA FFDE ; page ROM out)     1000 EXECUTE                                                  ;                                                                                                                               : PIVOT ( addr --) \ copy to RAM, init DP, disable ROM, jump      7E   1008 C!      1009 !         ( JMP addr ; go there)         piv ;                                                                                                                         : PIVOTRST ( - ) \ copy to RAM, init DP, disable ROM, jump rst    6E9F 1008  ! FFFE 100A !         ( JMP [FFFE] ; go there)       piv ;                                                         : MMUMAP \ enable MMU with 1-1 mapping                29aug15nac  10 0 DO I DUP 8 LSHIFT OR FFDE ! LOOP 20 FFDE C! ;                                                                            : EFTOCD ( --) \ map top 8K to C000-DFFF so it can be loaded      2607 FFDE ! ;                                                                                                                 : CDTOCD ( --) \ restore 1-1 map                                  2606 FFDE ! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 \ Multicomp extras: start CUBIX or BASIC or BUGGY     29aug15nac: CUBIX \ 4KB from SD at 0x2.0000                                 MMUMAP EFTOCD                                                   2 SDLBA2 0 D800 4 SDRDn 0 SDLBA2 ( load bootloader to F800)     CDTOCD PIVOTRST ;                ( restore map, go thru RST)                                                                  : BASIC \ 8KB from SD at 0x2.1000                                 MMUMAP EFTOCD                                                   2 SDLBA2 1000 C000 10 SDRDn 0 SDLBA2 ( load basic ROM to E000)  CDTOCD 2787 FFDE !           ( restore map, protect E000)       PIVOTRST ;                   ( go thru RST vector)                                                                            : BUGGY \ 7KB from SD at 0x2.1E00                                 MMUMAP EFTOCD                                                   2 SDLBA2 1E00 C400 E SDRDn 0 SDLBA2 ( load to E400)             CDTOCD PIVOTRST ; ( restore map, go thru RST vector)          \ Multicomp extras: start FLEX or NITROS9             30aug15nac: FLEX \ 512 bytes (256 used) from SD at 0x2.2000                 MMUMAP                                                          2 SDLBA2 2000 C100 1 SDRDn 0 SDLBA2                             C100 PIVOT ;                  ( entry point of loader)                                                                        : NITROS9 \ load track34 and start it                             \ disk is on SD at 0x2.8000 so track34 is at 0x2.84C8           MMUMAP EFTOCD                                                   2 SDLBA2 84C8 2600   \ load from 0x2.84C8 to 2600               12 SDRD256n 0 SDLBA2 \ 18 (hex 12) 256-byte sectors             \ vectors to RAM expected by krn                                0100 DFF2 ! 0103 DFF4 ! 010F DFF6 ! \ SWI3 SWI2 FIRQ            010C DFF8 ! 0106 DFFA ! 0109 DFFC ! \ IRQ  SWI  NMI             CDTOCD 2602 PIVOT ;  \ restore map, start at 2602                                                                             \ RSVD FOR MULTICOMP - LAST ONE                       29apr15nac                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      29apr15nac                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                CamelForth for the Motorola 6809  (c) 1995 Bradford J. Rodriguez*   Permission is granted to freely copy, modify, and          **   distribute this program for personal or educational use.   **   Commercial inquiries should be directed to the author at   **   221 King St. E., #32, Hamilton, Ontario L8N 1B5 Canada     *                                                                Direct-Threaded Forth model for Motorola 6809                   16 bit cell, 8 bit char, 8 bit (byte) adrs unit                   X = Forth W   temporary address register                        Y =       IP  Interpreter Pointer                               U =       RSP Return Stack Pointer                              S =       PSP Parameter Stack Pointer                           D =       TOS top parameter stack item                         DP =       UP  User Pointer (high byte)                                                                                        v1.0  alpha test version, 7 May 95                              \ 6809 Source Code: boot parameters              (c) 28apr95 bjrHEX E000 FFFF DICTIONARY ROM  ROM                                  7A00 EQU UP-INIT      \ UP must be page aligned.  Stacks,       7A   EQU UP-INIT-HI   \   TIB, etc. init'd relative to UP.                                                                      6000 EQU DP-INIT      \ starting RAM adrs for dictionary        \ SM2 memory map with 8K RAM: 6000-7BFF RAM, 7C00-7FFF I/O                                                                   \ Harvard synonyms - these must all be PRESUMEd                 AKA , I,     AKA @ I@     AKA ! I!                              AKA C, IC,   AKA C@ IC@   AKA C! IC!                            AKA HERE IHERE     AKA ALLOT IALLOT                             PRESUME WORD       AKA WORD IWORD                                                                                                                                                                                                                               \   6809 DTC: SCC initialization                 (c) 17apr95 bjrHERE EQU SCCATBL HEX                                               7C02 ,  2500 ,   \ port address, #bytes, reset reg ptr          09C0 ,  0444 ,  0100 ,  0200 ,  03C0 ,  0560 ,                  0901 ,  0A00 ,  0B50 ,  0C18 ,  0D00 ,  0E02 ,                  0E03 ,  03C1 ,  0568 ,  0F00 ,  1010 ,  0100 ,                                                                               HERE EQU SCCBTBL                                                   7C00 ,  1F00 ,   \ port address, #bytes, reset reg ptr          0444 ,  0100 ,  03C0 ,  0560 ,  0A00 ,  0B50 ,                  0C18 ,  0D00 ,  0E02 ,  0E03 ,  03C1 ,  0568 ,                  0F00 ,  1010 ,  0100 ,  \ 0909 ,                                                                                             ASM: HERE EQU SCCINIT   \ set up on-board i/o                      X ,++ LDY,   X ,+ LDB,                                          BEGIN,   X ,+ LDA,   Y 0, STA,   DECB,   EQ UNTIL,   RTS, ;C \   6809 DTC: serial I/O                         (c) 31mar95 bjrHEX 7C02 EQU SCCACMD   7C03 EQU SCCADTA                                                                                         CODE KEY    \ -- c    get char from serial port                    6 # ( D) PSHS,   BEGIN,   SCCACMD LDB,   1 # ANDB,  NE UNTIL,   SCCADTA LDB,   CLRA,   NEXT ;C                                                                                               CODE KEY?   \ -- f    return true if char waiting                  6 # ( D) PSHS,   CLRA,   SCCACMD LDB,   1 # ANDB,               NE IF,   -1 # LDB,   THEN,   NEXT ;C                                                                                         CODE EMIT   \ c --    output character to serial port              BEGIN,   SCCACMD LDA,   4 # ANDA,   NE UNTIL,                   SCCADTA STB,   6 # ( D) PULS,   NEXT ;C                                                                                                                                                      \   6809 DTC: interpreter logic                       01apr15nacASM:  HERE RESOLVES DOCOLON   HERE EQU <DOCOLON>                    HEX 20 # ( Y) PSHU,   20 # PULS,   NEXT, ;C                                                                                 ASM:  HERE RESOLVES DOCREATE   HERE EQU <DOCREATE>                  HEX 10 # ( X) PULS,   6 # ( D) PSHS,   X D TFR,   NEXT, ;C                                                                  CODE EXIT    \ --     exit a colon definition                       HEX 20 # ( Y) PULU,   NEXT ;C                                                                                               CODE LIT     \ -- x   fetch inline literal to stack                 6 # ( D) PSHS,   Y ,++ LDD,   NEXT ;C                                                                                       CODE EXECUTE  \ i*x xt -- j*x   execute Forth word at 'xt'          D X TFR,   6 # ( D) PULS,   X 0, JMP, ;C                                                                                    \   6809 DTC: stack operations                   (c) 31mar95 bjrCODE DUP    \ x -- x x       duplicate top of stack                 6 # ( D) PSHS,   NEXT ;C                                                                                                    CODE ?DUP   \ x -- 0 | x x   DUP if nonzero                         0 # CMPD,   NE IF,   6 # ( D) PSHS,   THEN,   NEXT ;C                                                                       CODE DROP   \ x --           drop top of stack                      6 # ( D) PULS,   NEXT ;C                                                                                                    CODE SWAP   \ x1 x2 -- x2 x1  swap top two items                    S 0, LDX,   S 0, STD,   X D TFR,   NEXT ;C                                                                                  CODE OVER   \ x1 x2 -- x1 x2 x1   per stack diagram                 6 # ( D) PSHS,   S 2 , LDD,   NEXT ;C                                                                                       \   6809 DTC: stack operations                   (c) 314apr15nacCODE ROT     \ x1 x2 x3 -- x2 x3 x1   per stack diagram             S 0, LDX,   S 0, STD,   S 2 , LDD,   S 2 , STX,   NEXT ;C                                                                   CODE NIP     \ x1 x2 -- x2            per stack diagram             S 2 , LEAS,   NEXT ;C                                                                                                       CODE TUCK    \ x1 x2 -- x2 x1 x2      per stack diagram             S 0, LDX,   S 0, STD,   HEX 10 # ( X) PSHS,   NEXT ;C       CODE PICK    \ x2 x1 x0 n -- x2 x1 x0 xn                            ASLB, ROLA,   S D, LDD,           NEXT ;C                                                                                   CODE >R      \ x --   R: -- x        push to return stack           6 # ( D) PSHU,   6 # ( D) PULS,   NEXT ;C                   CODE R>      \ -- x   R: x --        pop from return stack          6 # ( D) PSHS,   6 # ( D) PULU,   NEXT ;C                   \   6809 DTC: stack operations                   (c) 31mar95 bjrCODE R@     \ -- x   R: x -- x   fetch from return stack            6 # ( D) PSHS,   U 0, LDD,   NEXT ;C                                                                                        CODE SP@    \ -- a-addr         get data stack pointer              6 # ( D) PSHS,   S D TFR,   NEXT ;C                                                                                         CODE SP!    \ a-addr --         set data stack pointer              D S TFR,   6 # ( D) PULS,   NEXT ;C                                                                                         CODE RP@    \ -- a-addr         get return stack pointer            6 # ( D) PSHS,   U D TFR,   NEXT ;C                                                                                         CODE RP!    \ a-addr --         set return stack pointer            D U TFR,   6 # ( D) PULS,   NEXT ;C                                                                                         \   6809 DTC: memory operations                  (c) 31mar95 bjrCODE !      \ x a-addr --     store cell in memory                  D X TFR,   6 # ( D) PULS,   X 0, STD,   6 # ( D) PULS,          NEXT ;C                                                                                                                     CODE C!     \ char c-addr --     store char in memory               D X TFR,   6 # ( D) PULS,   X 0, STB,   6 # ( D) PULS,          NEXT ;C                                                                                                                     CODE @      \ a-addr -- x        fetch cell from memory             D X TFR,   X 0, LDD,   NEXT ;C                                                                                              CODE C@     \ c-addr -- char     fetch char from memory             D X TFR,   X 0, LDB,   CLRA,   NEXT ;C                                                                                                                                                      \   6809 DTC: arithmetic operations              (c) 26apr95 bjrCODE +      \ n1/u1 n2/u2 -- n3/u3   add n1+n2                      S ,++ ADDD,   NEXT ;C                                                                                                       CODE M+     \ d n -- d            add single to double              S 2 , ADDD,   S 2 , STD,                                        6 # ( D) PULS,   0 # ADCB,   0 # ADCA,   NEXT ;C                                                                            CODE -      \ n1/u1 n2/u2 -- n3/u3   subtract n1-n2                 S ,++ SUBD,   COMA,   COMB,   1 # ADDD,   NEXT ;C                                                                           CODE NEGATE   \ x1 -- x2     two's complement                       COMA,   COMB,   1 # ADDD,   NEXT ;C                                                                                                                                                                                                                         \   6809 DTC: logical operations                 (c) 31mar95 bjrCODE AND    \ x1 x2 -- x3     logical AND                           S ,+ ANDA,   S ,+ ANDB,   NEXT ;C                                                                                           CODE OR     \ x1 x2 -- x3     logical OR                            S ,+ ORA,    S ,+ ORB,    NEXT ;C                                                                                           CODE XOR    \ x1 x2 -- c3     logical XOR                           S ,+ EORA,   S ,+ EORB,   NEXT ;C                                                                                           CODE INVERT   \ x1 -- x2       bitwise inversion                    COMA,   COMB,   NEXT ;C                                                                                                     CODE ><       \ x1 -- x2      swap bytes                            A B EXG,   NEXT ;C                                                                                                          \   6809 DTC: arithmetic operations              (c) 31mar95 bjrCODE 1+     \ n1/u1 -- n2/u2         add 1 to TOS                   1 # ADDD,   NEXT ;C                                                                                                         CODE 1-     \ n1/u1 -- n2/u2         subtract 1 from TOS            1 # SUBD,   NEXT ;C                                                                                                         CODE 2*     \ x1 -- x2              arithmetic left shift           ASLB,   ROLA,   NEXT ;C                                                                                                     CODE 2/     \ x1 -- x2              arithmetic right shift          ASRA,   RORB,   NEXT ;C                                                                                                     CODE +!     \ n/u a-addr --         add cell to memory              D X TFR,   6 # ( D) PULS,   X 0, ADDD,   X 0, STD,              6 # ( D) PULS,   NEXT ;C                                    \   6809 DTC: arithmetic operations              (c) 31mar95 bjrCODE LSHIFT    \ x1 u -- x2      logical shift left u places        D X TFR,   6 # ( D) PULS,   X 0, LEAX,   NE IF,                     BEGIN,   LSLB,   ROLA,   X -1 , LEAX,   EQ UNTIL,           THEN,   NEXT ;C                                                                                                             CODE RSHIFT    \ x1 u -- x2      logical shift right u places       D X TFR,   6 # ( D) PULS,   X 0, LEAX,   NE IF,                     BEGIN,   LSRA,   RORB,   X -1 , LEAX,   EQ UNTIL,           THEN,   NEXT ;C                                                                                                                                                                                                                                                                                                                                                                                                                                             \   6809 DTC: comparison operations              (c) 31mar95 bjrCODE 0=     \ n/u -- flag     return true if TOS=0                  0 # CMPD,   EQ IF,                                                  HERE EQU TOSTRUE   -1 # LDD,  NEXT                          THEN,   CLRA,   CLRB,   NEXT ;C                                                                                             CODE 0<     \ n/u -- flag     true if TOS negative                  TSTA,   TOSTRUE BMI,   CLRA,   CLRB,   NEXT ;C                                                                              CODE =      \ x1 x2 -- flag   test x1=x2                            S ,++ SUBD,   TOSTRUE BEQ,   CLRA,   CLRB,   NEXT ;C                                                                        CODE <>     \ x1 x2 -- flag   test not equal                        S ,++ SUBD,   TOSTRUE BNE,   CLRA,   CLRB,   NEXT ;C                                                                                                                                        \   6809 DTC: comparison operations              (c) 31mar95 bjrCODE <      \ n1 n2 -- flag     test n1<n2, signed                  S ,++ SUBD,   TOSTRUE BGT,   CLRA,   CLRB,   NEXT ;C                                                                        CODE >      \ n1 n2 -- flag     test n1>n2, signed                  S ,++ SUBD,   TOSTRUE BLT,   CLRA,   CLRB,   NEXT ;C                                                                        CODE U<     \ n1 n2 -- flag     test n1<n2, unsigned                S ,++ SUBD,   TOSTRUE BHI,   CLRA,   CLRB,   NEXT ;C                                                                        CODE U>     \ n1 n2 -- flag     test n1>n2, unsigned                S ,++ SUBD,   TOSTRUE BLO,   CLRA,   CLRB,   NEXT ;C                                                                                                                                                                                                                                                                        \   6809 DTC: branch and loop operations         (c) 31mar95 bjrCODE BRANCH   \ --         branch always                            Y 0, LDY,   NEXT ;C                                                                                                         CODE ?BRANCH  \ x --      branch if TOS zero                        0 # CMPD,   EQ IF,   6 # ( D) PULS,   Y 0, LDY,   NEXT                      THEN,   6 # ( D) PULS,   Y 2 , LEAY,   NEXT ;C                                                                  CODE (DO)     \ n1|u1 n2|u2 --    R: -- sys1 sys2                   D X TFR,   HEX 8000 # LDD,   S ,++ SUBD,   \ fudg=8000-limit    6 # ( D) PSHU,   X D, LEAX,   10 # ( X) PSHU,   \ start+fudg    6 # ( D) PULS,   NEXT ;C                                                                                                    CODE UNLOOP   \ --    R: sys1 sys2 --     drop loop parameters      U 4 , LEAU,   NEXT ;C                                                                                                       \   6809 DTC: branch and loop operations         (c) 31mar95 bjrCODE (LOOP)   \ R: sys1 sys2 -- | sys1 sys2   run-time for LOOP     6 # ( D) PSHS,   U 0, LDD,   1 # ADDD,   VC IF,                     HERE EQU TAKELOOP   U 0, STD,   Y 0, LDY,                       6 # PULS,   NEXT                                            THEN,   Y 2 , LEAY,   U 4 , LEAU,   6 # PULS,   NEXT ;C                                                                     CODE (+LOOP)  \ n --   R: sys1 sys2 -- | sys1 sys2    for +LOOP     U 0, ADDD,   TAKELOOP BVC,                                      Y 2 , LEAY,   U 4 , LEAU,   6 # PULS,   NEXT ;C                                                                             CODE I        \ -- n   R: sys1 sys2 -- sys1 sys2     loop index     6 # ( D) PSHS,   U 0, LDD,   U 2 , SUBD,   NEXT ;C                                                                          CODE J        \ -- n   R: 4*sys -- 4*sys         2nd loop index     6 # ( D) PSHS,   U 4 , LDD,   U 6 , SUBD,   NEXT ;C         \   6809 DTC: multiply                                24mar15nacCODE UM*      \ u1 u2 -- ud   16*16->32 unsigned multiply          HEX 16 # ( X,D) PSHS,                    \ push temporary, u2   S 5 , LDA,  S 1 , LDB,  MUL,  S 2 , STD,   \ 1lo*2lo            S 4 , LDA,  S 1 , LDB,  MUL,               \ 1hi*2lo              S 2 , ADDB,  0 # ADCA,  S 1 , STD,                            S 5 , LDA,  S 0, LDB,  MUL,                \ 1lo*2hi              S 1 , ADDD,  S 1 , STD,  CLRA,  ROLA,    \ cy in A            S 0, LDB,  S 0, STA,  S 4 , LDA,  MUL,     \ 2hi*1hi              S 0, ADDD,                               \ hi result in D     S 2 , LDX,  S 4 , LEAS,  S 0, STX,  NEXT ;C   \ lo result                                                                                                                                                                                                                                                                                                                                    \   6809 DTC: divide                             (c) 25apr95 bjrCODE UM/MOD      \ ud u1 -- rem quot   32/16->16 divide            HEX 6 # PSHS,   10 # LDX,      \ save u1 in mem                 S 5 , ASL,  S 4 , ROL,         \ initial shift (lo 16)          BEGIN,                                                             S 3 , ROL,  S 2 , ROL,   S 2 , LDD,   \ shift left hi 16        CS IF,                  \ 1xxxx: 17 bits, subtract is ok           S 0, SUBD,  S 2 , STD,  0FE # ANDCC,   \ clear cy            ELSE,                   \ 0xxxx: 16 bits, test subtract            S 0, SUBD,  CC IF,  S 2 , STD,  THEN,  \ cs=can't subtr      THEN,                   \ cy=0 if sub ok, 1 if no subtract      S 5 , ROL,  S 4 , ROL,  \ rotate cy into result              X -1 , LEAX,  EQ UNTIL,    \ loop 16 times                      S 4 , LDD,  COMA,  COMB,   \ invert to get true quot in D       S 2 , LDX,  S 4 , STX,  S 4 , LEAS,   \ save rem, clean stack   NEXT ;C                                                      \   6809 DTC: block and string operations        (c) 31mar95 bjrCODE FILL   \ c-addr u char --    fill mem with char                HEX 20 # ( Y) PSHU,   30 # ( X,Y) PULS,   \ D=char X=u Y=adr    0 # CMPX,  NE IF,                                                   BEGIN,   Y ,+ STB,   X -1 , LEAX,   EQ UNTIL,               THEN,   6 # ( D) PULS,   20 # ( Y) PULU,  NEXT, ;C                                                                          CODE S=    \ c-addr1 c-addr2 u -- n    string compare 1:2           S 2 , ADDD,   S 2 , LDX,   S 2 , STY,     \ X=src D=end         S 0, LDY,   S 0, STD,   CLRB,             \ Y=dst B=0           BEGIN,   S 0, CMPX,   NE WHILE,   X ,+ LDA,   Y ,+ SUBA,            NE IF,   0 # SBCB,   B A TFR,   1 # ORB,                                 HEX 30 # ( X,Y) PULS,   NEXT,   THEN,              REPEAT,   B A TFR,   HEX 30 # ( X,Y) PULS,   NEXT, ;C                                                                                                                                       \   6809 DTC: block and string operations        (c) 31mar95 bjrCODE CMOVE  \ c-addr1 c-addr2 u --   move from bottom 1->2          S 2 , ADDD,   S 2 , LDX,   S 2 , STY,     \ X=src D=end         S 0, LDY,   S 0, STD,                     \ Y=dst               BEGIN,   S 0, CMPX,   NE WHILE,   X ,+ LDB,   Y ,+ STB,         REPEAT,   HEX 30 # ( X,Y) PULS,   6 # ( D) PULS,   NEXT ;C                                                                  CODE CMOVE>  \ c-addr1 c-addr2 u --   move from top 1->2            S 2 , LDX,  X D, LEAX,   S 2 , STY,       \ X=src D=u           S 0, LDY,   Y D, LEAY,                    \ Y=dst               BEGIN,   S 0, CMPY,   NE WHILE,   X -, LDB,   Y -, STB,         REPEAT,   HEX 30 # ( X,Y) PULS,   6 # ( D) PULS,   NEXT ;C                                                                                                                                                                                                                                                                  \   6809 DTC: block and string operations        (c) 31mar95 bjrASM: HERE EQU SKIPEXIT   Y -1 , LEAY,                           HERE EQU SKIPDONE  HEX 20 # PSHS,  X D TFR,  20 # PULU, NEXT ;C                                                                 CODE SKIP   \ c-addr u c -- c-addr' u'   skip matching chars        HEX 20 # ( Y) PSHU,   30 # ( X,Y) PULS,   \ D=char X=u Y=adr    0 # CMPX,   NE IF,                                                  BEGIN,   Y ,+ CMPB,   SKIPEXIT BNE,   X -1 , LEAX,          EQ UNTIL,   THEN,   SKIPDONE BRA,  ;C                                                                                       CODE SCAN   \ c-addr u c -- c-addr' u'   find matching char         HEX 20 # ( Y) PSHU,   30 # ( X,Y) PULS,   \ D=char X=u Y=adr    0 # CMPX,   NE IF,                                                  BEGIN,   Y ,+ CMPB,   SKIPEXIT BEQ,   X -1 , LEAX,          EQ UNTIL,   THEN,   SKIPDONE BRA,  ;C                                                                                       \   6809 DTC: system dependencies                (c) 21apr95 bjr                                                                \ These words are shorter in CODE than as colon definitions!    CODE ALIGNED  NEXT ;C               \ a1 -- a2  align address   CODE ALIGN   NEXT ;C                \ --        align HERE      CODE CELL+   2 # ADDD,  NEXT ;C     \ a1 -- a2  add cell size   CODE CELLS   ASLB,  ROLA,  NEXT ;C  \ n1 -- n2  cells->adr unitsCODE CHAR+   1 # ADDD,  NEXT ;C     \ a1 -- a2  add char size   CODE CHARS   NEXT ;C                \ n1 -- n2  chars->adr unitsCODE >BODY   3 # ADDD,  NEXT ;C     \ xt -- a-addr    cfa->pfa                                                                  AKA 1- CHAR-                                                    \ Note: CELL, a constant, must be defined after CONSTANT.                                                                                                                                                                                                       \   6809 DTC: system dependencies                (c) 21apr95 bjrHEX                                                             : COMPILE,   , ;                 \ xt --   append execution tokn: !CF       0BD OVER C! 1+ ! ;   \ adrs cfa --   set code field : ,CF       HERE !CF 3 ALLOT ;   \ adrs --     append code field: !COLON    -3 ALLOT <DOCOLON> ,CF ;   \ --  changes last c.f.  : ,EXIT     ['] EXIT COMPILE, ;  \ --      append EXIT action   : ,BRANCH   , ;                  \ xt --   append branch instr. : ,DEST     , ;                  \ dest --  append dest'n adrs  : !DEST     ! ;                  \ dest adr --   change dest'n                                                                                                                                                                                                                                                                                                                                                                                                  \   6809 DTC: dodoes (does>) does>               (c) 18apr95 bjr                                                                ASM:  HERE RESOLVES DODOES   HERE EQU <DODOES>                     HEX 20 # ( Y) PSHU,   20 # ( Y) PULS,   \ adrs of DODOES code   10 # ( X) PULS,   6 # ( D) PSHS,   X D TFR,  \ adrs of data     NEXT, ;C                                                     DECIMAL   \ to keep ,CF from compiling as a hex number                                                                          : (DOES>)   R>  LATEST @ NFA>CFA  !CF ;                                                                                         : DOES>    ['] (DOES>) COMPILE,   <DODOES> ,CF ;   IMMEDIATE                                                                                                                                                                                                                                                                                                                                    \   6809 DTC: defining words                     (c) 21apr95 bjr: :   CREATE HIDE ] !COLON ;                                                                                                    : ;   REVEAL ,EXIT  [COMPILE] [  ;   IMMEDIATE                                                                                  : CONSTANT   CREATE , ;CODE                                         HEX 10 # ( X) PULS,   6 # ( D) PSHS,   X 0, LDD,   NEXT, ;C EMULATE:  TCREATE T, MDOES> T@  ;EMULATE                                                                                        : VARIABLE   CREATE CELL ALLOT ;                                EMULATE:  TCREATE 0 T, MDOES>   ;EMULATE                                                                                        : USER   CREATE , ;CODE                                             HEX 10 # ( X) PULS,   6 # ( D) PSHS,       \ get pfa in X       DPR A TFR,  CLRB,   X 0, ADDD,   NEXT, ;C  \ UP+offset -> D EMULATE:  TCREATE T, MDOES> .UNDEF  ;EMULATE                    \   High level: control structures               (c) 21apr95 bjr: IF   \ -- adrs        conditional forward branch                  ['] ?BRANCH ,BRANCH  HERE DUP ,DEST ;                       EMULATE:  M['] ?BRANCH T,  THERE DUP T, ;EMULATE  IMMEDIATE                                                                     : THEN \ adrs --        resolve forward branch                      HERE SWAP !DEST ;                                           EMULATE:  THERE SWAP T! ;EMULATE          IMMEDIATE                                                                             : ELSE \ adrs1 -- adrs2   branch for IF..ELSE                       ['] BRANCH ,BRANCH  HERE DUP ,DEST                              SWAP [COMPILE] THEN ;                                       EMULATE:  M['] BRANCH T,  THERE DUP T,                              SWAP  THERE SWAP T! ;EMULATE         IMMEDIATE                                                                                                                                              \   High level: control structures               (c) 21apr95 bjr: BEGIN   HERE ;  \ -- adrs     target for backward branch      EMULATE: THERE   ;EMULATE        IMMEDIATE                                                                                      : UNTIL           \ adrs --     conditional backward branch         ['] ?BRANCH ,BRANCH  ,DEST ;                                EMULATE:  M['] ?BRANCH T, T, ;EMULATE  IMMEDIATE                                                                                : AGAIN           \ adrs --     unconditional backward branch       ['] BRANCH ,BRANCH  ,DEST ;                                 EMULATE:  M['] BRANCH T,  T, ;EMULATE   IMMEDIATE                                                                               : WHILE           \ -- adrs     branch for WHILE loop               [COMPILE] IF ;                                              EMULATE:  M['] ?BRANCH T,  THERE DUP T, ;EMULATE  IMMEDIATE                                                                     \   High level: control structures               (c) 21apr95 bjr: REPEAT          \ adrs1 adrs2 ---   resolve WHILE loop            SWAP [COMPILE] AGAIN [COMPILE] THEN ;                       EMULATE:  SWAP  M['] BRANCH T,  T,                                  THERE SWAP T! ;EMULATE          IMMEDIATE                                                                                   : >L   CELL LP +!  LP @ ! ;                                     : L>   LP @ @  CELL NEGATE LP +! ;                              : DO              \ -- adrs  L: -- 0                                ['] (DO) ,BRANCH  HERE  0 >L ;                              EMULATE: M['] (DO) T,  THERE  0 T>L  ;EMULATE  IMMEDIATE                                                                        : LEAVE  ['] UNLOOP COMPILE,                                        ['] BRANCH ,BRANCH   HERE DUP ,DEST  >L ;                   EMULATE:  M['] UNLOOP T,                                            M['] BRANCH T,  THERE DUP T, T>L  ;EMULATE   IMMEDIATE      \   High level: control structures               (c) 21apr95 bjr: ENDLOOP   ,BRANCH ,DEST    \ adrs xt --  L: 0 a1 a2 .. aN --      BEGIN L> ?DUP WHILE [COMPILE] THEN REPEAT ;                                                                                 ALSO FORTH ALSO META DEFINITIONS                                : TENDLOOP   T, T, BEGIN TL> ?DUP WHILE THERE SWAP T! REPEAT ;  PREVIOUS PREVIOUS DEFINITIONS                                                                                                   : LOOP   ['] (LOOP) ENDLOOP ;                                   EMULATE:  M['] (LOOP) TENDLOOP  ;EMULATE  IMMEDIATE                                                                             : +LOOP  ['] (+LOOP) ENDLOOP ;                                  EMULATE:  M['] (+LOOP) TENDLOOP  ;EMULATE  IMMEDIATE                                                                                                                                                                                                            \   High level: system variables and constants   (c) 21apr95 bjrHEX  2 CONSTANT CELL     \ system dependent constant                20 CONSTANT BL                                                  7E CONSTANT TIBSIZE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         \   High level: system variables and constants   (c) 31mar95 bjrHEX -80 USER TIB      \ -- a-addr   Terminal Input Buffer             0 USER U0       \ -- a-addr   current user area adrs            2 USER >IN      \ -- a-addr   holds offset into TIB             4 USER BASE     \ -- a-addr   holds conversion radix            6 USER STATE    \ -- a-addr   holds compiler state              8 USER DP       \ -- a-addr   holds dictionary pointer         0A USER 'SOURCE  \ -- a-addr   two cells: length, address       0E USER LATEST   \ -- a-addr   last word in dictionary          10 USER HP       \ -- a-addr   HOLD pointer                     12 USER LP       \ -- a-addr   leave-stack pointer             100 USER S0       \ -- a-addr   end of parameter stack          128 USER PAD      \ -- a-addr   user PAD buffer/end of hold     180 USER L0       \ -- a-addr   bottom of leave stack           200 USER R0       \ -- a-addr   end of return stack                                                                         \   High level: arithmetic operators             (c) 31mar95 bjr: S>D         \ n -- d   single -> double precision                 DUP 0< ;                                                    : ?NEGATE     \ n1 n2 -- n3   negate n1 if n2 negative              0< IF NEGATE THEN ;                                         : ABS         \ n1 -- n2      absolute value                        DUP ?NEGATE ;                                               : DNEGATE     \ d1 -- d2      negate, double precision              SWAP INVERT SWAP INVERT 1 M+ ;                              : ?DNEGATE    \ d1 n -- d2    negate d1 if n negative               0< IF DNEGATE THEN ;                                        : DABS        \ d1 -- d2      absolute value, double precision      DUP ?DNEGATE ;                                                                                                                                                                                                                                              \   High level: arithmetic operators             (c) 31mar95 bjr: M*          \ n1 n2 -- d       signed 16*16->32 multiply          2DUP XOR >R                                                     SWAP ABS SWAP ABS UM*                                           R> ?DNEGATE ;                                                                                                               : SM/REM      \ d1 n1 -- n2 n3   symmetric signed division          2DUP XOR >R                                                     OVER >R                                                         ABS >R DABS R> UM/MOD                                           SWAP R> ?NEGATE                                                 SWAP R> ?NEGATE ;                                                                                                                                                                                                                                                                                                           \   High level: arithmetic operators             (c) 31mar95 bjr: FM/MOD      \ d1 n1 -- n2 n3   floored signed division            DUP >R                                                          SM/REM                                                          DUP 0< IF                                                           SWAP R> +                                                       SWAP 1-                                                     ELSE  R> DROP  THEN ;                                                                                                       : *          \ n1 n2 -- n3        signed multiply                   M* DROP ;                                                   : /MOD       \ n1 n2 -- n3 n4     signed divide/remainder           >R S>D R> FM/MOD ;                                          : /          \ n1 n2 -- n3        signed divide                     /MOD NIP ;                                                                                                                  \   High level: arithmetic operators             (c) 31mar95 bjr: MOD         \ n1 n2 -- n3       signed remainder                  /MOD DROP ;                                                 : */MOD       \ n1 n2 n3 -- n4 n5   n1*n2/n3, remainder&quotient    >R M* R> FM/MOD ;                                           : */          \ n1 n2 n3 -- n4      n1*n2/n3                        */MOD NIP ;                                                                                                                 : MAX         \ n1 n2 -- n3         signed maximum                  2DUP < IF SWAP THEN DROP ;                                  : MIN         \ n1 n2 -- n3         signed minimum                  2DUP > IF SWAP THEN DROP ;                                                                                                                                                                                                                                                                                                  \   High level: double operators                 (c) 31mar95 bjr: 2@          \ a-addr -- x1 x2     fetch 2 cells                   DUP CELL+ @ SWAP @ ;                                        : 2!          \ x1 x2 a-addr --     store 2 cells                   SWAP OVER ! CELL+ ! ;                                       : 2DROP       \ x1 x2 --            drop 2 cells                    DROP DROP ;                                                 : 2DUP        \ x1 x2 -- x1 x2 x1 x2   dup top 2 cells              OVER OVER ;                                                 : 2SWAP       \ x1 x2 x3 x4 -- x3 x4 x1 x2    per diagram           ROT >R ROT R> ;                                             : 2OVER       \ x1 x2 x3 x4 -- x1 x2 x3 x4 x1 x2   per diagram      >R >R 2DUP R> R> 2SWAP ;                                                                                                                                                                                                                                    \   High level: input/output                     (c) 31mar95 bjrHEX                                                             : COUNT       \ c-addr1 -- c-addr2 u    counted->addr/length        DUP CHAR+ SWAP C@ ;                                         : CR          \ --                      output newline              0D EMIT 0A EMIT ;                                           : SPACE       \ --                      output a space              BL EMIT ;                                                   : SPACES      \ u --                    output u spaces             BEGIN DUP WHILE SPACE 1- REPEAT DROP ;                      : UMIN        \ u1 u2 -- u              unsigned minimum            2DUP U> IF SWAP THEN DROP ;                                 : UMAX        \ u1 u2 -- u              unsigned maximum            2DUP U< IF SWAP THEN DROP ;                                                                                                                                                                 \   High level: input/output                     (c) 31mar95 bjr: ACCEPT      \ c-addr +n -- +n'   get line from terminal           OVER + 1- OVER                                                  BEGIN KEY                                                       DUP 0D <> WHILE                                                     DUP EMIT                                                        DUP 8 = IF  DROP 1-  >R OVER R> UMAX                                  ELSE  OVER C!  1+ OVER UMIN                               THEN                                                        REPEAT                                                          DROP NIP SWAP - ;                                                                                                           : TYPE        \ c-addr +n --        type line to terminal           ?DUP IF                                                             OVER + SWAP DO I C@ EMIT LOOP                               ELSE DROP THEN ;                                            \   High level: input/output                     (c) 31mar95 bjr: (S")        \ -- c-addr u        run-time code for S"             R> COUNT 2DUP + ALIGN >R ;                                                                                                  ALSO FORTH ALSO META DEFINITIONS                                : TS"   22 WORD DUP C@ 1+ THERE OVER TALLOT SWAP >TCMOVE ;      PREVIOUS PREVIOUS DEFINITIONS                                                                                                   : S"          \ --             compile in-line string               ['] (S") COMPILE,                                               22 WORD   C@ 1+ ALIGNED  ALLOT ;                            EMULATE:  M['] (S") T,  TS"  ;EMULATE   IMMEDIATE                                                                               : ."          \ --             compile string to print              [COMPILE] S" ['] TYPE COMPILE, ;                            EMULATE:  M['] (S") T,  TS"  M['] TYPE T,  ;EMULATE  IMMEDIATE  \   High level: numeric output                   (c) 31mar95 bjr: UD/MOD      \ ud1 u2 -- u3 ud4     32/16->32 divide               >R 0 R@ UM/MOD  ROT ROT R> UM/MOD ROT ;                     : UD*         \ ud1 u2 -- ud3        32*16->32 multiply             DUP >R UM* DROP  SWAP R> UM* ROT + ;                        : HOLD        \ char --             add char to output string       -1 HP +!  HP @ C! ;                                         : <#          \ --                  begin numeric conversion        PAD HP ! ;                                                  : >DIGIT      \ n -- c              convert to 0..9A..Z             DUP 9 > 7 AND + 30 + ;                                      : #           \ ud1 -- ud2          convert 1 digit of output       BASE @ UD/MOD ROT >DIGIT HOLD ;                             : #S          \ ud1 -- ud2          convert remaining digits        BEGIN # 2DUP OR 0= UNTIL ;                                                                                                  \   High level: numeric output                   (c) 31mar95 bjr: #>          \ ud1 -- c-addr u      end conversion, get string     2DROP HP @ PAD OVER - ;                                     : SIGN        \ n --                 add minus sign if n<0          0< IF 2D HOLD THEN ;                                        : U.          \ u --                 display u unsigned             <# 0 #S #> TYPE SPACE ;                                     : .           \ n --                 display n signed               <# DUP ABS 0 #S ROT SIGN #> TYPE SPACE ;                    : DECIMAL     \ --                   set number base to decimal     0A BASE ! ;                                                 : HEX         \ --                   set number base to hex         10 BASE ! ;                                                                                                                                                                                                                                                 \   High level: dictionary management            (c) 31mar95 bjr: HERE        \ -- addr              returns dictionary ptr         DP @ ;                                                      : ALLOT       \ n --             allocate n adr units in dict       DP +! ;                                                     : ,           \ x --             append cell to dict                HERE !  1 CELLS ALLOT ;                                     : C,          \ char --          append char to dict                HERE C!  1 CHARS ALLOT ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \   High level: interpreter                      (c) 31mar95 bjr: SOURCE      \ -- adr n         current input buffer               'SOURCE 2@ ;                                                : /STRING     \ a u n -- a+n u-n           trim string              ROT OVER + ROT ROT - ;                                      : >COUNTED    \ src n dst --        copy to counted string          2DUP C! CHAR+ SWAP CMOVE ;                                  : WORD        \ char -- c-addr      word delim'd by char            DUP  SOURCE >IN @ /STRING                                       DUP >R   ROT SKIP                                               OVER >R  ROT SCAN                                               DUP IF CHAR- THEN                                               R> R> ROT -   >IN +!                                            TUCK -                                                          HERE >COUNTED   HERE                                            BL OVER COUNT + C! ;                                        \   High level: interpreter                           01apr15nac: NFA>LFA     \ nfa -- lfa      name adr -> link field              2 - ;                                                       : NFA>CFA     \ nfa -- cfa      name adr -> code field              COUNT 3F AND + ;                                            : IMMED?      \ nfa -- f        fetch immediate flag                C@ 40 AND ;                                                 : FIND        \ c-addr -- c-addr 0/1/-1   not found/immed/normal    LATEST @ BEGIN              \ -- a nfa                              2DUP C@ BF AND SWAP C@  \ -- a nfa n1 n2                        = IF 2DUP CHAR+ SWAP DUP CHAR+ SWAP C@ S= ELSE 1 THEN           DUP IF DROP NFA>LFA @ DUP THEN                              0= UNTIL                    \ -- a nfa  OR  a 0                 DUP IF                      \ if found, check immed status          NIP DUP NFA>CFA         \ -- nfa xt                             SWAP IMMED?  0= 1 OR  THEN ;                            \   High level: interpreter                      (c) 31mar95 bjr: LITERAL     \ x --       append numeric literal                   STATE @ IF  ['] LIT COMPILE,  I, THEN ;                     EMULATES TLITERAL                       IMMEDIATE                                                                               HEX                                                             : DIGIT?      \ c -- n -1 | x 0    true if c is a valid digit      DUP 39 > 100 AND +              \ silly looking,                DUP 140 > 107 AND -  30 -       \ but it works!                 DUP BASE @ U< ;                                              : ?SIGN       \ adr n -- adr' n' f   get optional sign             OVER C@                 \ -- adr n c                            2C - DUP ABS 1 = AND    \ -- +=-1, -=+1, else 0                 DUP IF 1+               \ +=0, -=+2        NZ=negative              >R 1 /STRING R>     \ adr' n' f                             THEN ;                                                       \   High level: interpreter                      (c) 31mar95 bjr: >NUMBER     \ ud adr u -- ud' adr' u'  conv. string to number     BEGIN DUP WHILE                                                     OVER C@ DIGIT?                                                  0= IF DROP EXIT THEN                                            >R 2SWAP BASE @ UD*                                             R> M+ 2SWAP   1 /STRING                                     REPEAT ;                                                                                                                    : ?NUMBER     \ c-addr -- n -1 | c-addr 0     string->number        DUP  0 0 ROT COUNT     \ -- ca ud adr n                         ?SIGN >R  >NUMBER      \ -- ca ud adr' n'                       IF  R> 2DROP 2DROP 0   \ -- ca 0   (error)                      ELSE  2DROP NIP R>                                                  IF NEGATE THEN -1  \ -- n -1   (ok)                         THEN ;                                                      \   High level: interpreter                      (c) 31mar95 bjr: INTERPRET   \ i*x c-addr u -- j*x   interpret given buffer        'SOURCE 2!  0 >IN !                                             BEGIN  BL WORD  DUP C@ WHILE        \ -- textadr                    FIND  ?DUP IF                   \ -- xt 1/-1                        1+ STATE @ 0= OR            \ immed or interp?                  IF EXECUTE ELSE COMPILE, THEN                               ELSE                            \ -- textadr                        ?NUMBER IF  [COMPILE] LITERAL  \ converted ok                   ELSE  COUNT TYPE 3F EMIT CR ABORT  THEN  \ error            THEN                                                        REPEAT DROP ;                                                                                                               : EVALUATE   \ i*x c-addr u -- j*x   interpret string               'SOURCE 2@ >R >R  >IN @ >R   INTERPRET                          R> >IN !  R> R> 'SOURCE 2!  ;                               \   High level: interpreter                      (c) 07may95 bjr: QUIT        \ --   R: i*x --    interpret from keyboard           L0 LP !  R0 RP!  0 STATE !    \ reset stacks, state             BEGIN                                                               TIB DUP TIBSIZE ACCEPT SPACE                                    INTERPRET                                                       CR STATE @ 0= IF ." OK " THEN                               AGAIN ;                                                                                                                     : ABORT       \ i*x --  R: j*x --   clear stack and QUIT            S0 SP!  QUIT ;                                              : ?ABORT      \ f c-addr u --       abort and print message         ROT IF TYPE ABORT THEN 2DROP ;                              : ABORT"      \ i*x 0 -- i*x        abort, print inline msg         [COMPILE] S" ['] ?ABORT COMPILE, ;                          EMULATE:  M['] (S") T,  TS"  M['] ?ABORT T,  ;EMULATE IMMEDIATE \   High level: interpreter                      (c) 3          : '           \ -- xt        find word in dictionary                BL WORD FIND   0= ABORT" ?" ;                               : CHAR        \ -- char      parse ASCII character                  BL WORD 1+ C@ ;                                             : [CHAR]      \ --           compile character literal              CHAR  ['] LIT COMPILE,  I, ;  IMMEDIATE                     ( *host action?* )                                                                                                              : (           \ --           skip input until )                     29 WORD DROP ;           IMMEDIATE                                                                                          : \           \ --           skip input until end of buffer         SOURCE >IN ! DROP ;      IMMEDIATE                                                                                                                                                          \   High level: compiler                              01apr15nac: CREATE      \ --        create an empty definition                LATEST @ I,             \ link field                            IHERE LATEST !          \ new "latest" link                     BL IWORD IC@ 1+ IALLOT  \ name field                            <DOCREATE> ,CF ;        \ code field                                                                                        : RECURSE     \ --        recurse current definition                LATEST @ NFA>CFA COMPILE, ;  IMMEDIATE                      ( *host action?* )                                                                                                              : [           \ --        enter interpretive state                  0 STATE ! ;  IMMEDIATE                                      : ]           \ --        enter compiling state                     -1 STATE ! ;                                                                                                                \   High level: compiler                         (c) 331mar15nacHEX                                                             : HIDE        \ --        "hide" latest definition                  LATEST @ DUP  IC@ 80 OR SWAP IC! ;                          : REVEAL      \ --        "reveal" latest definition                LATEST @ DUP  IC@ 7F AND SWAP IC! ;                         : IMMEDIATE   \ --        make last definition immediate            LATEST @ DUP @ 40 OR SWAP IC! ;                             : [']         \ --        find word and compile as literal          '  ['] LIT COMPILE,  I, ;  IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                                                                        \   High level: compiler                         (c) 31mar95 bjr: POSTPONE    \ --    postpone compile action of word               BL WORD FIND  DUP 0= ABORT" ?"  \ find word                     0< IF  ['] LIT COMPILE,  I,    \ non-immed: compiles later             ['] COMPILE, COMPILE,   \ add "LIT xt COMPILE," to df    ELSE  COMPILE,  THEN ;  IMMEDIATE   \ immed: compile into df( *host action?* )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \   High level: other operations                 (c) 25apr95 bjr: WITHIN   \ n1|u1 n2|u2 n3|u3 -- f   n2<=n1<n3?                    OVER - >R - R> U< ;                                                                                                         : MOVE     \ addr1 addr2 u --    smart move                         >R 2DUP SWAP DUP R@ +                                           WITHIN IF  R> CMOVE>  ELSE  R> CMOVE  THEN ;                                                                                : DEPTH    \ -- n                                                   SP@ S0 SWAP - 2/ ;      \ 16 BIT VERSION!                                                                                   : ENVIRONMENT?   \ c-addr u -- i*x true    system query             2DROP 0 ;    \          -- false                                                                                                                                                                                                                            \   High level: utility words                    (c) 231mar15nac: WORDS         \ --     list all words in dictionary               LATEST @ BEGIN                                                      DUP COUNT 3F AND TYPE SPACE                                     NFA>LFA @                                                   DUP 0= UNTIL                                                    DROP ;                                                      EMULATES WORDS                                                                                                                  : .S            \ --     print contents of stack                    SP@ S0 - IF                                                         SP@ S0 2 - DO  I @ h.  -2 +LOOP                             THEN ;                                                      EMULATES .S                                                                                                                                                                                     \   High level: startup                               29apr15nac: COLD        \ --        cold start Forth system                   UINIT U0 #INIT CMOVE                                            ." 6809 CamelForth v1.0  25 Apr 95"  CR                         ABORT ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     \   Testing words                                     24mar15nacHEX                                                             : .H  ( n - )   0F AND 30 + DUP 39 > IF 7 + THEN EMIT ;         : .HH ( n - )   DUP 2/ 2/ 2/ 2/ .H .H ;                         : .HHHH ( n - )   DUP 2/ 2/ 2/ 2/ 2/ 2/ 2/ 2/ .HH .HH ;         : H.  ( n - )   .HHHH SPACE ;                                   : .B  ( a - a+1 )   DUP C@ .HH SPACE 1+ ;                       : .A  ( a - a+1 )   DUP C@ DUP 20 7F WITHIN 0= IF                 DROP 2E ( . ) THEN EMIT 1+ ;                                  : DUMP ( a n - )  0 DO CR DUP H. SPACE DUP                          .B .B .B .B .B .B .B .B SPACE .B .B .B .B .B .B .B .B           DROP SPACE                                                      .A .A .A .A .A .A .A .A       .A .A .A .A .A .A .A .A           10 +LOOP DROP ;                                                                                                                                                                             \ simple memory test                                  03may15nac: STUP  \ start-addr end-addr -- start-addr end-addr              2DUP SWAP DO I DUP      ! CELL +LOOP ;                        : STUPI \ start-addr end-addr -- start-addr end-addr              2DUP SWAP DO I NEGATE I ! CELL +LOOP ;                                                                                        : TSTUP  \ start-addr end-addr -- start-addr end-addr             2DUP SWAP DO I DUP @      <> IF                                 ."  Error@" I U. THEN CELL +LOOP ;                            : TSTUPI \ start-addr end-addr -- start-addr end-addr             2DUP SWAP DO I NEGATE I @ <> IF                                 ."  Error@" I U. THEN CELL +LOOP ;                                                                                            : PASS STUP TSTUP STUPI TSTUPI ; ( do 1 pass)                   : PASSES 0 DO ." ." PASS LOOP ;  ( do N passes)                                                                                 \   6809 DTC: reset initialization               (c) 25apr95 bjrASM: HERE EQU ENTRY   HEX                                          CLRA,  F000 STA,  INCA,  E000 STA,  INCA,  D000 STA,            INCA,  C000 STA,  INCA,  B000 STA,  INCA,  A000 STA,            INCA,  9000 STA,  INCA,  8000 STA,  \ init mem mapping          UP-INIT-HI # LDA,   A DPR TFR,   \ initial UP                   UP-INIT 100 + # LDS,             \ initial SP                   UP-INIT 200 + # LDU,             \ initial RP                   SCCATBL # LDX,  SCCINIT JSR,     \ init serial ports            SCCBTBL # LDX,  SCCINIT JSR,                                    ' COLD JMP,   ;C           \ enter top-level Forth word      ASM: HERE EQU IRET   RTI,  ;C                                   HERE  0FFF0 ORG    \ 6809 hardware vectors                        IRET ,  IRET ,  IRET ,  IRET ,    \ tbd, SWI3, SWI2, FIRQ       IRET ,  IRET ,  IRET ,  ENTRY ,   \ IRQ, SWI, NMI, RESET      ORG                                                             \   6809 DTC: user area initialization           (c) 25apr95 bjrDECIMAL 18 CONSTANT #INIT   \ # bytes of user area init data                                                                    CREATE UINIT  HEX                                                  0 , 0 , 0A , 0 ,         \ reserved,>IN,BASE,STATE              DP-INIT ,                \ DP                                   0 , 0 ,                  \ SOURCE init'd elsewhere           META ALSO FORTH TLATEST @ T, PREVIOUS TARGET    \ LATEST           0 ,                      \ HP init'd elsewhere               \ Note that UINIT must be the *last* word in the kernel, in     \ order to set the initial LATEST as shown above.  If this is   \ not the last word, be sure to patch the LATEST value above.                                                                                                                                                                                                                                                                   Type  1 LOAD  to load the compiler & generate a 6809 Forth.                                                                     CHROMIUM.SCR screens index                                        0- 29  Chromium 2 metacompiler                                 30- 44  6809 assembler                                          45- 59  > TBD <                                                 60-119  6809 CamelForth source code                                                                                            120-149  metacompiler shadows                                   150-175  > TBD <                                                176-239  binary image (output)                                                                                                                                                                                                                                                                                                                                                                  Version 2 improvements:                                         1. Generalized the forward-reference mechanism so that it can be   used within the metacompiler, eliminating 'DOVAR 'LIT etc.   2. Added ability to predefine host actions of target words.     3. Added DUAL mechanism to build host analogs of target words.  4. Factored ITC/DTC/STC dependencies into a small word set.                                                                     LIMITATIONS of the Chromium metacompiler, release 2 (2 Apr 95)  1. The target Forth word size must be the same as or smaller       than the host's.  Thus only 16-bit Forths can be produced.   2. When metacompiling, the same WIDTH is used in the host and      target dictionaries.  This really isn't a limitation.        3. Word-aligned machines not yet supported.                     4. T['] cannot do forward references.                           5. Target colon definitions cannot span multiple blocks.        6. T: and T; must be rewritten if STC is to be used.            OFFSET  defines simple data-structure words.                    AKA  defines a synonym word.  Usage:  AKA oldword newname       THRU  is redefined to print screen number & stack contents.     :NONAME  begins a headerless Forth definition in the host, and     returns the address (cfa) of the new definition.             ;NONAME  ends a headerless Forth definition in the host.        COMPILE, appends an execution token to a host Forth definition.                                                                 META  holds the words which comprise the metacompiler.          ASSEMBLER  holds the cross-assembler.                           TARGET  holds the "symbol" words for all target definitions,       plus target compiler directives.  TARGET is selected during     metacompilation and metainterpretation.  Within TARGET is a     vocabulary tree exactly paralleling that of the target Forth.                                                                                                                                These words store the target image in a range of Forth screens.    BIG ENDIAN: Most Significant byte is at LOWER adrs, e.g.6809 BASE-SCREEN  is the starting screen # of this range.  There is     no ending screen #; up to 64 screens (64K) can be used.         You may change this to suit your disk layout.                ><  swaps the hi and lo bytes of the top stack item. <16 BIT!>  VIRTUAL  converts a target image address to an address within      a block buffer.  Adrs 0000 is the first byte of BASE-SCREEN. TC@ TC!  fetch and store bytes in the target image.             T@ T!  fetch and store 16-bit cells in the target image.  Since    a cell may cross a block boundary, these must be done with      byte operations.                                             >TCMOVE  copies a string from the host memory to the image.     TEXECUTE  executes the target word at address a.  Since we are     compiling to disk, this simply prints an error message.      >T T>  move data to and from the target stack (future use).     These words define the target memory model.                                                                                     CELL size and CHAR size are specified in target address units.  Any needed conversion to host address units will be done by     the memory reference words.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     These words manage multiple dictionaries in the target image.   'TDP  holds the address of the "current" dictionary.            DICTIONARY  given origin and limit addresses, defines a dict.      When executed it will become the "current" dictionary.       TDP THERE TALLOT  are analogous to their host counterparts         except that they work in 'target addresses'.                 ?FULL  aborts if the current DP exceeds its limit.              T, TC,  store words/bytes into the image.                       ORG  sets the current target DP to a new value.                                                                                 The T prefix signifies "target", thus THERE should be read as   "target HERE".  Normally I hate T-prefix names; these will be   imported into the TARGET vocabulary without the T prefix.                                                                                                                                                                                                       These words embody the target threading model and alignment.    TALIGN  aligns the target dictionary ptr; TALIGNED aligns any     target address.  (These are no-ops on the byte-aligned 6809).                                                                 *Note* Chromium 2 assumes all word references in the target use Absolute addresses, with an optional prefix:   STC  DTC  ITC    ,!XT  begins a Forth thread reference.         JSR  ---  ---    ,!CF  begins the code field of a Forth word.   ---  JSR  ---    ,CODE  lays the code field of a CODE word.     ---  ---  Here+2                                                                 T!CF  changes the code field of the target Forth word at 'tadr'.   This should also store the JSR/JMP instruction, if used.     T>BODY  converts a target cfa (technically, xt) to a target pfa.                                                                                                                                                                                                These words define the target header structure.  (CamelForth)      These are model-specific but usually not CPU-specific.          If n-way hashed lists and peculiar vocabulary schemes are       used in the target, this screen can become much more complex!HEADS  if 0, will prevent headers from being generated.         TLATEST  holds the target nfa of the last word defined in the      target.  Note that the linking scheme is model-specific.     (THEADER)  builds a header in the target, except for the code      field, linking it into the image dictionary.  It parses a       WORD non-destructively.  Header layout is model-specific.    (TIMMEDIATE)  makes the LATEST target word "immediate".            This is also model-specific.                                                                                                 Once this screen is loaded, we have all the support words       needed for the assembler.                                                                                                       Generic definition for the 'mirror' word.  These words reside in  the TARGET vocabulary and are executed during metacompilation.TARG-VALUE  is usually the address of the corresponding target     word.  It may also be a numeric value (for an EQUATE).       HOST-COMP  is what the host executes in compile state.          HOST-EXEC  is what the host executes in interpret state.        FWD-LIST  is the head of this word's forward-reference list.    MIRR-LINK  maintains a linked list of all mirror words.         TSTATE  is -1 when metacompiling, 0 when metainterpreting.      MLATEST  is the mirror word most recently CREATEd.              'MIRROR  holds the pfa of the last-defined mirror word.         MIRROR  creates a mirror word in the host, initializing its        forward-ref list to empty.  The action of a mirror word is      to execute either the HOST-COMP or HOST-EXEC vector, with       the address of this data structure in the variable 'MA.      MA  returns the data address of the mirror word being exec'd.   Forward references are accumulated in a linked list in the      HOST's memory space.  Each element in the list contains a link  (0 for end of list), followed by the address in the target whichhas to be "patched" later.  The mirror word holds the list head.                                                                !REF  uses the mirror's PUT-CODE to patch a reference.          ,REF  uses the mirror's PUT-CODE to append a reference.         +FWDREF  is the basic compile action for a forward-reference.     It adds the target HERE to the list of patch addresses.         'MA' is the pfa of the mirror word ('mirror address').        (RESOLVE)  given 'adrs' within the target, and pfa of a mirror    word 'ma', patches all forward references, then zaps the fwd    list head.  Sets value; does not change comp/exec actions.      NB: all references assumed to be one-cell absolute addresses!                                                                                                                                 Each target word has associated with it (in the "mirror" word)  a "compiling" action and an "executing" action.  For most words compiling is "compile my address" and executing is "error".     .UNDEF  is the execute action for a forward-referenced word.      Since the value is not yet known, print an error message.     PRESUME name   predefines a forward reference to a target word,   so it can be used within the metacompiler -- e.g. LIT, EXIT.    PRESUME-CF defines a code field, PRESUME-ADRS a simple adrs.  EMULATES name   changes the action of the MLATEST mirror to the    host word 'name'.  Works w/PRESUME, eg, PRESUME @ EMULATES T@EMULATE: ..code.. ;EMULATE   changes the action of the MLATEST     mirror word to the given Forth code.                         TIMMEDIATE  makes the latest target word immediate, by setting     (TIMMEDIATE) and MIMMEDIATE.                                 T' name   gets the cfa (xt) of a target word, by fetching it      from the mirror word 'name'.                                  ?MIRROR  must recognize three cases.  (Note: may change 'MA)    1. Target word has been forward-referenced (or PRESUMEd):          Resolve value and set compile action in existing mirror word.   Leave execute action alone (may have been pre-defined).      2. Mirror word exists but is NOT fwd ref (duplicate definition):   Leave old mirror word alone; build new mirror word.          3. Mirror does not exist: build new mirror word.                                                                                RESOLVES  is a convenience, e.g., HERE RESOLVES DOCREATE.         The word being resolved had better be a mirror word!                                                                                                                                                                                                                                                                                                                                                                                                          This is the metacompiler's CREATE.                              DOCREATE  is a mirror word for the target's DOCREATE code.  We    define this now so the metacompiler can forward-reference it.                                                                 TCREATE  builds an (optional) header in the target, then builds   (or resolves) a mirror word whose value=target cfa, and whose   action is to compile that target word into a target thread.     Finally it builds the default target code field (DOCREATE).   CODE  is similar, but does not compile a reference to DOCREATE,   and adds the meta assembler to the search order.              END-CODE  drops the meta assembler from the search order.                                                                                                                                                                                                                                                                                                                                       These words handle EQUATEs and compile literal values.          LIT  is a mirror word for the target's LIT.  We define this now    so that TLITERAL can forward-reference it.                   TLITERAL  compiles a single cell literal into the image.           NOTE: this implementation won't handle fwd STC references!   @EQU  is the execute action for an Equate (fetch TARG-VALUE).   ,EQU  is the compile action for an Equate (append a TLITERAL).  EQU  defines an equate with value n.                                                                                            DUAL  when true, causes mirror words to be compiled in the host   while target words are compiled in the target.  This builds an  analog ("dual") of the target colon definition in the host.                                                                                                                                                                                                                                                                   T[  sets metainterpreting state.                                T]  sets metacompiling state and enters the meta compiling loop.   Words from the input stream are searched (in the TARGET         vocabulary) and executed.  The execution action of a defined    target word is to compile itself.  Other words, such as         compiler directives, perform their programmed action.           This loop will end upon ; or [.  F83 note: colon definitions    cannot cross screen boundaries.                                                                                              Note that while metacompiling, all words are actually executed! The metacompiler works like an assembler in this regard.                                                                                                                                                                                                                                                                                                                                        Target interpretation is only valid when the target CPU is      actually connected "live" to the host CPU.                                                                                      D>T  pushes a single or double number on the target's stack.       This uses the talker word >T , put a number on target stack.                                                                 TINTERPRET and TQUIT  are a modified interpreter loop to run       Forth words remotely on the target machine.  Numbers are        pushed on the target stack.  Target words are automatically     INVOKEd when their mirror words are executed on the host.                                                                    HOT  starts the target interpreter.  This will run until COOL      is executed, or UNTIL ANY ERROR CONDITION IS ENCOUNTERED.       (F83 restarts its own QUIT after any error!)                                                                                                                                                 DOCOLON  is a mirror word for the target's DOCOLON code.        EXIT  is a mirror word for the target's EXIT.  We define these    now so that T: and T; can forward-reference them.                                                                             T:  starts a target colon definition, building the target header  and code field, and entering metacompile state.  If DUAL is     true, builds the code field for the host analog, and stores     this as the execute action of the mirror word.                                                                                T;  ends a target colon definition and leaves metacompile state.  If DUAL, ends the analog definition in the host.                NOTE: this version does not correctly handle STC.                                                                             Normally I hate "T-prefix" names, but when these are imported   into the TARGET vocabulary, they'll be known as : and ;.                                                                        These words allow the host machine to correctly build "defining"and "defined" words in the target.  The target's DODOES code and(DOES>) word need to be forward-referenced.                     TARG-DOES  holds the address of the target's DOES> code.        TPFA  as a mirror action, returns the pfa of the target word.   (MDOES>)  when executed by the host machine, changes the execute   action of the most recently defined target word, in the image   AND in the host's mirror word.  The host's "execute" vector     is set to the address immediately following the (DOES>) .    MDOES>  a) adds the target DOES address and meta (MDOES>) to the   host's colon definition; b) builds a headerless colon def       for the host's DOES> action, and starts it with TPFA.        TDOES>  a) compiles target (DOES>) and JSR DODOES, and saves the   target DOES address; b) performs MDOES> if dual is enabled.  You really need to see a picture to understand this.            Refer also to the target's source code for DOES> and ;CODE .    These are words which must be recognized while metacompiling    (i.e., while in the TARGET vocabulary), but which have no       equivalent in the target Forth.                                                                                                 AKA xxx xxx  simply makes a synonym in the TARGET vocabulary.                                                                   TARGET  is the root of the "mirrored" dictionary tree, which       will be built in the host.  This tree will hold all of the      "mirror" words and will exactly duplicate the search order      of the dictionary being built in the image. (scr # 2)                                                                        Once the TARGET vocabulary is sealed, the only exits are        META  to select the META vocabulary                             ASSEMBLER  to select the META ASSEMBLER vocabulary              CODE  to create a code header and select META ASSEMBLER                                                                         These are words which will be defined in the target Forth, but  which also have equivalent actions in the host.  Each is        predefined here as a forward reference with a specified execute action (PRESUME targ-name EMULATES host-word).  When the target definition for the word is given (CODE, colon, or CREATE),      the execute action will remain unchanged AS LONG AS "DUAL" IS   SWITCHED OFF!                                                                                                                   These are the words which can be used in "dual" definitions.    (Note that AKA words cannot be used in duals!)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  These words implement Charles Curley's DUMP as part of the      image compiler.  Use META DUMP to look at the target image.     Use NATIVE DUMP for the "original" dump of F83's memory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Usage:  HOST  address length HEXFILE filename.ext                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               These words store the target image in a range of Forth screens.    LITTLE ENDIAN: Most Significant byte is at HIGHER address,      e.g. 8086 or Z80                                                                                                             Only T@ and T! are changed from the previous screen.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            These words store the target image directly to target memory,   working through a resident "talker" program running on the      target CPU.  The talker provides the following functions:          XADR  set address in target                                     X!+   store byte and advance address                            X@+   fetch byte and advance address                            GO    jump to machine language subroutine at given address      AWAIT wait for subroutine to complete (talker re-entered)                                                                    INVOKE  executes the target Forth word at address a.               This issues a GO command to the talker, then an AWAIT to        wait for the talker program to regain control.                                                                                                                                                                                                                                                                               This is the same as the previous screen except for the byte     order of T@ and T!.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   04may15nac                                                                                                                                                                                                                                                                                                                                                                                                We're executing from ROM but we want to disable the ROM so that the underlying RAM appears. To do this, we need to be NOT       executing from ROM, so we load a fragment of code to RAM,       including the ROM disable, and branch to it and thence to the   new ROM replacement. By inspection, both CUBIX and BASIC rely   on the reset value of DP so initialise that, too.                                                                                                                                                                                                                                                                     01may15nacCUBIX loads the 2kbyte ROM image from SDCARD, puts it into RAM  pages it in and jumps to it.                                    Cannot protect it because protect resolution is 8KByte and,     by deduction, the boot process expects RAM in at least some     of that region. The ROM image includes the vectors at the end   (eg, for the SWIs) and these vector to locations DExx                                                                           BASIC loads the 8kbyte BASIC ROM image from SDCARD, puts it     in RAM pages it in, protects it and jumps into it. From         working with the ROM image in the emulator I already know that  its memory size algorithm is destructive so the RAM image of    the BASIC ROM must be write protected. The sizing does not      corrupt memory but it will set RAMTOP to the top of the ROM     which will cause bits of the ROM to be overwritten.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             D7       D0                                           01apr15nac+----------+                                 CamelForth         |  link    | <- lfa (link field address)     Header             +          +                                 Format             |          |                                                    +----------+                                                    |S|P| len  | <- nfa (name field address)                        +-+-+------+                                                    |          |    P is the "precedence" bit - set for IMMEDIATE   +          +    words.                                          |          |    S is the "smudge" bit - set during word defn.   +  name    +    to prevent FIND from locating the definition    |          |    that is in progress; this allows a word to be   +-..-..-..-+    redefined (use RECURSE for deliberate recursion)|          | <- cfa (code field address)                                                                                                                                              13mar15 nathe link field points to the NFA of the previous definition     the link field is 0000 for the oldest definition                the variable LATEST points to the NFA of the youngest definition                                                                                                                                It is possible to combine P and S bits in the length field and  that is what Fig-Forth, Pygmy and F83 all do.                   The author wrote that he chose not to do that because using     a separate byte allowed the use of "normal" string operators    (ie that work on counted strings) like S= in FIND and TYPE in   WORDS.                                                          This design decision comes at a cost (1 byte per definition).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         01apr15nac                                                                                                                                                                                                                                                                                                                                                                                                                                                                The core of FIND is a string match. The incoming string is      a normal counted string. The string to search against in the    dictionary might have bit 6 (Immediate) set in its length byte. Therefore, we fetch that length byte, mask out the Immediate    bit and compare against the length of the incoming string. Only on length match do we do a string compare (with S=) of the rest of the string. On mismatch we move to the next entry in the     dictionary.. until we succeed or reach the end.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       13mar15 naINTERPRET is an almost verbatim translation of the algorithm    given in section 3.4 of the ANS document. It parses one         space-delimited string from the input and tries to FIND the     Forth word of that name. If the word is found, it will either beexecuted (if it is an IMMEDIATE word, or if in the "interpret"  state, STATE=0) or compiled into the dictionary (if in the      "compile" state, STATE=1). If not a Forth word and not a valid  number, the string is typed, an error message is displayed      and the intepreter ABORTs. This process is repeated, string by  string, until the end of the input line is reached.                                                                                                                                                                                                                                                                                                                                                                                                   28apr15nacCOLD initializes the user variables from a startup table and    then does ABORT                                                                                                                 ABORT resets the parameter stack pointer and does QUIT                                                                          QUIT resets the return stack pointer, loop stack pointer and    interpret state (STATE) and then begins to interpret Forth      commands. The name is apt, because QUIT can be used to abort an application and get back to the "top-level" of Forth. Unlike    ABORT, QUIT will leave the parameter stack alone. QUIT is an    infinite loop that will ACCEPT a line from the keyboard and thenINTERPRET it as Forth commands. When not compiling, QUIT will   prompt "ok" after each line.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    